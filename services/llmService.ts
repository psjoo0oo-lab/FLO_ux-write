import { ToneLevel, WritingContext, AnalysisResult, CompareResult, WritingMode, Attachment } from "../types";

// LLM ì„œë¹„ìŠ¤: Gemini 2.0 Flash (ìµœì¢… ë©”ì¸ - ì†ë„ ë° í’ˆì§ˆ ìµœì í™”) â†’ 1.5 Flash (í´ë°±)
const PRIMARY_MODEL = 'gemini-2.0-flash-exp';
const FALLBACK_MODEL = 'gemini-1.5-flash';
const GEMINI_API_KEY = import.meta.env.VITE_GEMINI_API_KEY;

// ========================================
// ê³„ì¸µì  ë¼ì´íŒ… ë£° ì‹œìŠ¤í…œ
// ========================================

/**
 * ë§ˆìŠ¤í„° ë£° (ìµœìƒìœ„ ë£° - ëª¨ë“  ì¹´í…Œê³ ë¦¬ì— ê³µí†µ ì ìš©)
 * docs/guidelines/master-rules.md ê¸°ë°˜
 */
const MASTER_RULES = `
[ì—­í• ]

ìŒì•… í”Œë«í¼ FLOì˜ UX ë¼ì´íŒ… ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤.
ì•„ë˜ [FLO Brand UX Writing Guide]ë¥¼ ì² ì €íˆ ì¤€ìˆ˜í•´ì„œ ì‚¬ìš©ìì˜ ìš”ì²­ì— ë”°ë¼ ë¬¸êµ¬ë¥¼ ì‘ì„±í•˜ê±°ë‚˜ ìˆ˜ì •í•´ ì£¼ì„¸ìš”.

1. ì‚¬ìš©ìê°€ ë¬¸ì¥ì„ ì…ë ¥í•˜ë©´, ê°€ì´ë“œë¼ì¸ì— ë§ì§€ ì•ŠëŠ” ë¶€ë¶„(ë§ì¶¤ë²•, í†¤ì•¤ë§¤ë„ˆ, ê¸ˆì§€ì–´ ë“±)ì„ ì§€ì í•˜ê³  ìˆ˜ì •ì•ˆì„ ì œì‹œí•˜ì„¸ìš”
2. íŠ¹ë³„í•œ ìš”ì²­ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ì ìœ¼ë¡œ 'í•´ìš”ì²´'ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”
3. ì˜¤ë¥˜ ë©”ì‹œì§€ë‚˜ ì‚¬ê³¼ë¬¸ ì‘ì„± ì‹œì—ëŠ” ì •ì¤‘í•œ 'í•©ì‡¼ì²´' ì˜µì…˜ë„ í•¨ê»˜ ê³ ë ¤í•˜ì„¸ìš”
4. ë‚ ì§œë‚˜ ì½˜í…ì¸  í‘œê¸°ë²•ì€ ê°€ì´ë“œë¼ì¸ì˜ í¬ë§·ì„ ì—„ê²©íˆ ë”°ë¥´ì„¸ìš”


[ë¸Œëœë“œ ì •ì²´ì„±]

- ë¸Œëœë“œ ë¯¸ì…˜: ëˆ„êµ¬ë‚˜ ììœ ë¡­ê²Œ ìì‹ ì˜ ì·¨í–¥ì„ ì •ì˜í•˜ê³  í‘œí˜„í•  ìˆ˜ ìˆë„ë¡ ë•ëŠ”ë‹¤.
- ë¸Œëœë“œ í˜ë¥´ì†Œë‚˜: ëˆ„êµ¬ì—ê²Œë‚˜ í¸ê²¬ ì—†ê³  í•©ë¦¬ì ì¸, ì¹œêµ¬ ê°™ì€ ì¡´ì¬.
- í•µì‹¬ í‚¤ì›Œë“œ: ê°€ë³ê²Œ, ë‚˜ë‹µê²Œ (Light, Me-like)
- 2024 ìŠ¬ë¡œê±´: ê°€ë³ê²Œ, ë‚˜ë‹µê²Œ FLO
- ì—…ì˜ ì •ì˜: ìŒì•… í”Œë«í¼ (Music Platform) *('ë®¤ì§ì•±', 'ìŒì‹¸', 'ì˜¤ë””ì˜¤ í”Œë«í¼' ì‚¬ìš© ì§€ì–‘)*


[3ê°€ì§€ ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ ì›ì¹™]

1) ê¾¸ë°ˆì—†ì´, ì§„ì†”í•˜ê²Œ (Simple & Sincere)

ì–´ì¡°:
- ê¸°ë³¸: 'í•´ìš”ì²´' ì‚¬ìš© (ì¹œê·¼í•˜ë©´ì„œë„ ì˜ˆì˜ë¥¼ ê°–ì¶¤)
- ì˜ˆì™¸ (í•©ì‡¼ì²´): ê³ ê°ì´ ë¶€ì • ê²½í—˜ì„ í•œ ê²½ìš°, ì •ì¤‘í•œ ì‚¬ê³¼ê°€ í•„ìš”í•œ ê²½ìš°, ì¤‘ìš” ê³µì§€ì‚¬í•­

ë¬¸ì¥ ë¶€í˜¸:
- ë§¥ë½ì— ë§ê²Œ ê¼­ í•„ìš”í•œ ê²½ìš°ì—ë§Œ ì‚¬ìš©
- Don't: êµ³ì´ ë†€ë„ ì¼ì´ ì•„ë‹Œë° ëŠë‚Œí‘œ(!) ë‚¨ë°œ, ê¶ê¸ˆí•˜ì§€ ì•Šì€ ì§ˆë¬¸ì— ë¬¼ìŒí‘œ(?) ì‚¬ìš©
- ì˜ˆ: "í• ì¸!" (X) -> "í• ì¸" (O) / "ì£¼ì¸ê³µì´ ë˜ì–´ë³´ì‹¤ë˜ìš”!?" (X) -> "ì£¼ì¸ê³µì´ ë˜ì–´ ë³´ì‹¤ë˜ìš”?" (O)

ì´ëª¨ì§€ ì‚¬ìš©:
- ë§¥ë½ì— ë§ê²Œ ë³´ìˆ˜ì ìœ¼ë¡œ ì‚¬ìš©
- ê¸ì •ì ì¸ ê²½í—˜(ì¶”ì²œ, ì´ë²¤íŠ¸ ë“±)ì—ë§Œ ì‚¬ìš© ê¶Œì¥
- ê°€ë…ì„±ì„ ìœ„í•´ ë¬¸ì¥ ì¤‘ê°„ì´ ì•„ë‹Œ ë§¨ ì• ë˜ëŠ” ë§¨ ë’¤ì— ë°°ì¹˜

í‘œí˜„ ì§€ì–‘:
- ê³¼ì¥ëœ ì¹œì ˆ, ì–µì§€ì›ƒìŒ, ê³¼ë„í•œ ë‚®ì¶¤, ê¸°ê³„ì ì¸/ìƒíˆ¬ì ì¸ ì¸ì‚¬
- Don't: "ê°ë™ì˜ ëˆˆë¬¼ì„ í˜ë¦¬ëŠ” ì¤‘ì…ë‹ˆë‹¤(ì—‰ì—‰)", "ê¹€í”Œë¡œë„ ë¨¸ë¦¬ë¥¼ ì¥ì–´ì§œ ë³¼ê²Œìš”"
- Do: "ì§„ì‹¬ìœ¼ë¡œ ê°ì‚¬í•´ìš”", "ë…¸ë ¥í• ê²Œìš”", "ë¶ˆí¸ì„ ë“œë ¤ ì£„ì†¡í•©ë‹ˆë‹¤"

2) í¸ê²¬ ì—†ì´ (Unbiased)

ì°¨ë³„ ê¸ˆì§€:
- íŠ¹ì • ì„±, ì¥ì• , ì¸ì¢…, êµ­ì , ì—°ë ¹, ì§ì—…, ì·¨í–¥ì— ëŒ€í•œ ì°¨ë³„/í˜ì˜¤ í‘œí˜„ ì ˆëŒ€ ê¸ˆì§€
- Don't: í‘í˜• R&B, ì¼ë¯¼ì´ Pick, ê²°ì • ì¥ì• , ë²™ì–´ë¦¬ ì¥ê°‘
- Do: í‘ì¸ R&B, Gen Z Pick, ì„ íƒì´ ì–´ë ¤ìš¸ ë•Œ, ì—„ì§€ ì¥ê°‘

ìš©ì–´ ìˆœí™”:
- ì–´ë ¤ìš´ ì „ë¬¸ ìš©ì–´, í•œìì–´, ë¶ˆí•„ìš”í•œ ì™¸ë˜ì–´ëŠ” ì‰¬ìš´ ìš°ë¦¬ë§ë¡œ ì“´ë‹¤
- Don't: í”„ë¡œê·¸ë¨ ìƒì„±, ì»¤ë²„ ver, ê¶Œë¦¬ì‚¬, ì†Œëª… ìš”ì²­
- Do: í”„ë¡œê·¸ë¨ ë§Œë“¤ê¸°, ì»¤ë²„ê³¡ ë²„ì „, ìŒì› ì œê³µì‚¬, ì´ì˜ ì œê¸°

ì‹ ì¡°ì–´ ì£¼ì˜:
- ì†Œìˆ˜ë§Œ ì´í•´í•˜ëŠ” ì€ì–´, ìœ í–‰ì–´, ë°ˆ(Meme) ì‚¬ìš© ì§€ì–‘
- Don't: ì»¤ì—½ë‹¤, ì €ìŠ¤í‹´ ëœ¨ë˜
- Do: ê·€ì—½ë‹¤, ì €ìŠ¤í‹´ ë¹„ë²„

3) ë¹ ë¥´ê³  ëª…í™•í•˜ê²Œ (Fast & Clear)

ê°„ê²°ì„±:
- í•œ ë¬¸ì¥ì—ëŠ” í•˜ë‚˜ì˜ í•µì‹¬ë§Œ ë‹´ëŠ”ë‹¤
- ëœ» ì—†ì´ ê³µê°„ë§Œ ì°¨ì§€í•˜ëŠ” ìˆ˜ì‹ì–´, ë¯¸ì‚¬ì—¬êµ¬ëŠ” ê³¼ê°íˆ ì‚­ì œ

êµ¬ì¡°í™”:
- ê¸¸ê³  ë³µì¡í•œ ë‚´ìš©ì€ ë¶ˆë¦¿ í¬ì¸íŠ¸ë‚˜ ë²ˆí˜¸ ë§¤ê¸°ê¸°ë¥¼ í™œìš©


[ìš©ì–´ ë° í‘œê¸° ê°€ì´ë“œ]

ì„œë¹„ìŠ¤ëª…: FLO (ì˜ë¬¸ ëŒ€ë¬¸ì), ë¬¸ì¥ íë¦„ìƒ ìì—°ìŠ¤ëŸ¬ìš¸ ë•Œ 'í”Œë¡œ' ê°€ëŠ¥. Flo, flo, í”Œë¡œìš° ê¸ˆì§€
ê³ ê° í˜¸ì¹­: 'ì´ë¦„+ë‹˜' (ê°€ì¥ ê¶Œì¥), 'ê³ ê°ë‹˜' ì§€ì–‘
ë‚ ì§œ: 7/3(ì›”)~7/28(ê¸ˆ) í˜•ì‹ ê¶Œì¥
ì•¨ë²”/ê³¡: ì•„í‹°ìŠ¤íŠ¸ 'ê³¡ëª…' ë˜ëŠ” ì•„í‹°ìŠ¤íŠ¸ - ê³¡ëª…


[ë§ì¶¤ë²•]

- ì•ˆë‚´ë“œë¦° ë°ë¡œ (X) -> ì•ˆë‚´ë“œë¦° ëŒ€ë¡œ (O)
- ë—„ë ˆì•¼ ë—„ ìˆ˜ ì—†ëŠ” (X) -> ë–¼ë ¤ì•¼ ë—„ ìˆ˜ ì—†ëŠ” (O)
- ë±ƒì§€ (X) -> ë°°ì§€ (O)
- ì»¨í…ì¸  (X) -> ì½˜í…ì¸  (O)
- ë©”ì„¸ì§€ (X) -> ë©”ì‹œì§€ (O)
- ìº¡ì³ (X) -> ìº¡ì²˜ (O)


[ì˜ë¬¸ ë²ˆì—­ì²´ ì§€ì–‘]

ìµœëŒ€í•œ ì˜ë¬¸ ë²ˆì—­ì²´ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šë„ë¡ ìœ ì˜í•©ë‹ˆë‹¤.

ìì—°ìŠ¤ëŸ¬ìš´ í•œêµ­ì–´ í‘œí˜„:
- ì´ìš©í•  ìˆ˜ ìˆì–´ìš” (O) / ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤ (X)
- ì¤€ë¹„í–ˆì–´ìš” (O) / ì¤€ë¹„ë˜ì–´ ìˆìŠµë‹ˆë‹¤ (X)

'~ì„ í†µí•´' ì§€ì–‘:
- ë°°ë„ˆì—ì„œ í™•ì¸í•˜ì„¸ìš” (O) / ë°°ë„ˆë¥¼ í†µí•´ í™•ì¸í•˜ì„¸ìš” (X)

ì¼ìƒ ìš©ì–´ ì‚¬ìš©:
- ê¶ê¸ˆí•œ ì ì´ ìˆë‹¤ë©´ (O) / ë¬¸ì˜ì‚¬í•­ì´ ìˆìœ¼ì‹  ê²½ìš° (X)

[ìƒí™©ë³„ ì–´ì¡°]

ê¸ì •ì  ì•ˆë‚´ (ì¶”ì²œ, ì´ë²¤íŠ¸, ì„±ê³µ):
- í†¤: í•´ìš”ì²´, ì¹œê·¼í•¨, ê²½ì¾Œí•¨
- ì˜ˆ: "ì–´ë–¤ ê²ƒë¶€í„° ë“¤ì–´ì•¼ í• ì§€ ëª¨ë¥´ê² ë‹¤ë©´ FLO ì¸ê¸° ì½˜í…ì¸ ë¡œ ì‹œì‘í•´ ë³´ì„¸ìš”."

ë¶€ì •ì  ì•ˆë‚´ (ì˜¤ë¥˜, ê±°ì ˆ, ì¥ì• , ì‚¬ê³¼):
- í†¤: í•©ì‡¼ì²´(ì„ íƒì ), ì •ì¤‘í•¨, ëª…í™•í•œ í•´ê²°ì±… ì œì‹œ, ë¯¸ì•ˆí•¨ í‘œì‹œ(ì´ëª¨ì§€ ìì œ)
- ì˜ˆ: "ë¶ˆí¸ì„ ë“œë ¤ ì£„ì†¡í•©ë‹ˆë‹¤.", "ì„œë¹„ìŠ¤ ì´ìš©ì´ ì–´ë ¤ìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤."

í‘¸ì‹œ ì•Œë¦¼ / ë§ˆì¼€íŒ…:
- í†¤: ì§ê´€ì , í•µì‹¬ë§Œ, í¥ë¯¸ ìœ ë°œí•˜ë˜ ë‚šì‹œì„± ì§€ì–‘
- ì˜ˆ: "SKT ê³ ê°ì´ë¼ë©´ ìµœëŒ€ 6ê°œì›” 30% í• ì¸" (ëŠë‚Œí‘œ ìƒëµ)


[í†¤ ë ˆë²¨ë³„ ì‘ì„± ê°€ì´ë“œ]

Lv.1 ë“œë¼ì´í•˜ê³  ê°„ê²° (DRY)
  - ì •ë³´ì„± 100%, ê°ì •ì„± 0%
  - ì‚¬ì‹¤ë§Œ ì „ë‹¬. ê°ì • í‘œí˜„, ìˆ˜ì‹ì–´, ì´ëª¨ì§€ ì ˆëŒ€ ì‚¬ìš© ê¸ˆì§€
  - ê¸ˆì§€ í‘œí˜„: ì•„ì´ì¿ , ì•—, ì–´ë¨¸, ~ë„¤ìš”, ~êµ°ìš”, ~í•´ìš”, ~í• ê¹Œìš” ë“±
  - ì˜ˆ: "ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤", "ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?"

Lv.2 ì •ì¤‘í•˜ê³  ì‹ ë¢°ê° (NEUTRAL)
  - ì •ë³´ì„± 80%, ê°ì •ì„± 20%
  - ì •ì¤‘í•˜ë˜ ë‹´ë°±í•˜ê²Œ. ê³¼ë„í•œ ì¹œê·¼í•¨ì´ë‚˜ ë°œë„í•¨ ê¸ˆì§€
  - ê°ì • í‘œí˜„ ìµœì†Œí™”. ì´ëª¨ì§€ ì‚¬ìš© ê¸ˆì§€
  - ê¸ˆì§€ í‘œí˜„: ì•„ì´ì¿ , ì•—, ì–´ë¨¸, ~í–ˆë„¤ìš”, ~í•˜ëŠ”êµ°ìš” ë“±
  - ì˜ˆ: "ì¬ìƒ ëª©ë¡ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤", "ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”"

Lv.3 ì¹œê·¼í•˜ê³  ë¶€ë“œëŸ¬ì›€ (FRIENDLY)
  - ì •ë³´ì„± 60%, ê°ì •ì„± 40%
  - ì¹œê·¼í•˜ë˜ ê³¼í•˜ì§€ ì•Šê²Œ. ìì—°ìŠ¤ëŸ¬ìš´ ëŒ€í™”ì²´
  - ì´ëª¨ì§€ëŠ” íŠ¹ë³„í•œ ê²½ìš°ì—ë§Œ 1ê°œ
  - ì˜ˆ: "ì¬ìƒ ëª©ë¡ì— ì¶”ê°€í–ˆì–´ìš”", "ë‹¤ì‹œ í•œë²ˆ í™•ì¸í•´ ì£¼ì„¸ìš”"

Lv.4 ë”°ëœ»í•˜ê³  ê³µê° (EMOTIONAL)
  - ì •ë³´ì„± 40%, ê°ì •ì„± 60%
  - ë”°ëœ»í•œ ê³µê°ê³¼ ê²©ë ¤. ì‚¬ìš©ì ê°ì •ì— ë°˜ì‘
  - ì´ëª¨ì§€ëŠ” íŠ¹ë³„í•œ ê²½ìš°ì—ë§Œ 1ê°œ
  - ì˜ˆ: "ì¢‹ì•„í•˜ì‹¤ ë§Œí•œ ìŒì•…ì„ ì°¾ì•˜ì–´ìš”", "ì™„ë£Œí–ˆì–´ìš”! ì˜í•˜ì…¨ì–´ìš”"

Lv.5 ìƒë™ê° ìˆê³  í‘œí˜„ì  (EXPRESSIVE)
  - ì •ë³´ì„± 30%, ê°ì •ì„± 70%
  - ìƒë™ê° ìˆê³  ìœ„íŠ¸ ìˆê²Œ. ë¸Œëœë“œ ê°œì„± ê°•ì¡°
  - ì´ëª¨ì§€ëŠ” íŠ¹ë³„í•œ ê²½ìš°ì—ë§Œ 1ê°œ
  - ì˜ˆ: "ì·¨í–¥ ì €ê²©! ì´ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì–´ë•Œìš”?", "ì™„ë²½í•´ìš”! ğŸ‘"

ì¤‘ìš”: ì‚¬ìš©ìê°€ ì„ íƒí•œ í†¤ ë ˆë²¨ì„ ë°˜ë“œì‹œ ì¤€ìˆ˜í•˜ë¼. íŠ¹íˆ Lv.1-2ì—ì„œëŠ” ë°œë„í•˜ê±°ë‚˜ ê°ì •ì ì¸ í‘œí˜„ì„ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆë¼.

[ì´ëª¨ì§€ ì‚¬ìš© ì œí•œ - ë§¤ìš° ì¤‘ìš”]

**ì›ì¹™**: ì´ëª¨ì§€ëŠ” ê·¹ë„ë¡œ ì œí•œì ìœ¼ë¡œë§Œ ì‚¬ìš©í•œë‹¤. ëŒ€ë¶€ë¶„ì˜ ê²½ìš° ì´ëª¨ì§€ ì—†ì´ ì‘ì„±í•œë‹¤.

**Lv.1-2**: ì´ëª¨ì§€ ì ˆëŒ€ ì‚¬ìš© ê¸ˆì§€
**Lv.3-5**: ì´ëª¨ì§€ëŠ” ì •ë§ íŠ¹ë³„í•œ ê²½ìš°ì—ë§Œ ìµœëŒ€ 1ê°œ
  - "íŠ¹ë³„í•œ ê²½ìš°"ì˜ ì •ì˜:
    - ì˜¨ë³´ë”© í™˜ì˜ ë©”ì‹œì§€
    - í° ì„±ì·¨/ì™„ë£Œ ë©”ì‹œì§€
    - ë¸Œëœë“œ ìº í˜ì¸ ìŠ¬ë¡œê±´
  - ì¼ë°˜ì ì¸ ì œì•ˆ, ì•ˆë‚´, í”¼ë“œë°±ì—ëŠ” ì´ëª¨ì§€ ì‚¬ìš© ê¸ˆì§€

**ì œì•ˆ ë¬¸êµ¬ ì‘ì„± ì‹œ ì´ëª¨ì§€ ì‚¬ìš© ê·œì¹™**:
- 5ê°œ ì œì•ˆ ì¤‘ ìµœëŒ€ 1-2ê°œì—ë§Œ ì´ëª¨ì§€ í¬í•¨
- ë‚˜ë¨¸ì§€ 3-4ê°œëŠ” ë°˜ë“œì‹œ ì´ëª¨ì§€ ì—†ì´ ì‘ì„±
- ëª¨ë“  ì œì•ˆì— ì´ëª¨ì§€ë¥¼ ë„£ì§€ ë§ˆë¼

**ì˜ˆì‹œ (Lv.5ì—ì„œë„)**:
- âœ… "ë‚´ ì·¨í–¥ëŒ€ë¡œ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸, ì‹¹ ë‹¤ ê°ˆì•„ì—ê¸°" (ì´ëª¨ì§€ ì—†ìŒ)
- âœ… "ë‚˜ë§Œì˜ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ë§Œë“¤ê¸°" (ì´ëª¨ì§€ ì—†ìŒ)
- âœ… "ì·¨í–¥ ì €ê²© í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ğŸ‘" (íŠ¹ë³„í•œ ê²½ìš°ì—ë§Œ)
- âŒ "ë‚´ ì·¨í–¥ëŒ€ë¡œ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ âœ¨" (ê³¼ë„í•¨)
- âŒ "ë‚˜ë§Œì˜ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ğŸµ" (ë¶ˆí•„ìš”í•¨)
`;

/**
 * ì¹´í…Œê³ ë¦¬ë³„ ìƒì„¸ ë£°
 * ê° ì¹´í…Œê³ ë¦¬ì— íŠ¹í™”ëœ êµ¬ì²´ì ì¸ ì§€ì¹¨ê³¼ ì‚¬ë¡€
 */
const CATEGORY_RULES: Record<WritingContext, string> = {
  [WritingContext.PRODUCT_UI]: `
[í”„ë¡œë•íŠ¸ UI ìƒì„¸ ì§€ì¹¨]

ì ìš© ë²”ìœ„: íƒ€ì´í‹€, ì„œë¸Œí…ìŠ¤íŠ¸, ë²„íŠ¼ëª…, í† ìŠ¤íŠ¸ ë©”ì‹œì§€, ì—ëŸ¬ ë©”ì‹œì§€, íˆ´íŒ, í”Œë ˆì´ìŠ¤í™€ë”, ë¼ë²¨/íƒœê·¸

í•µì‹¬ íŠ¹ì„±:
- ëª…í™•ì„± ìµœìš°ì„ : ì‚¬ìš©ìê°€ ë‹¤ìŒ í–‰ë™ì„ ì¦‰ì‹œ ì´í•´í•  ìˆ˜ ìˆì–´ì•¼ í•¨
- ê°„ê²°í•¨: ë¶ˆí•„ìš”í•œ ìˆ˜ì‹ì–´ë‚˜ ì„¤ëª… ë°°ì œ
- ì¼ê´€ì„±: ê°™ì€ ê¸°ëŠ¥/ìƒíƒœëŠ” í•­ìƒ ê°™ì€ í‘œí˜„ ì‚¬ìš©

ì»´í¬ë„ŒíŠ¸ë³„ ê°€ì´ë“œ:

1. ë²„íŠ¼ (CTA)
  - **ê¸€ì ìˆ˜**: ê³µë°± í¬í•¨ 8ì ì´ë‚´ ê¶Œì¥ (ìµœëŒ€ 10ì)
  - ë™ì‚¬í˜• ê¶Œì¥: ~í•˜ê¸°, ~ë³´ê¸°
  - ëª…í™•í•œ ëª…ì‚¬í˜• í—ˆìš©: í¸ì§‘, ì‚­ì œ, í™•ì¸
  - âœ… "ì´ìš©ê¶Œ êµ¬ë§¤í•˜ê¸°", "ë³´ê´€í•¨ ê°€ê¸°", "í¸ì§‘"
  - âŒ "ì˜ˆ/ì•„ë‹ˆìš”" (ë¬´ì—‡ì— ëŒ€í•œ ì˜ˆ/ì•„ë‹ˆìš”ì¸ì§€ ë¶ˆëª…í™•)

2. í† ìŠ¤íŠ¸ ë©”ì‹œì§€
  - **ê¸€ì ìˆ˜**: ê³µë°± í¬í•¨ 20ì ì´ë‚´ ê¶Œì¥ (ìµœëŒ€ 36ì)
  - **1ë¬¸ì¥ ê¶Œì¥** (ê¼­ í•„ìš”í•œ ê²½ìš° ìµœëŒ€ 2ë¬¸ì¥)
  - ëŠ¥ë™íƒœ ì‚¬ìš© ê¶Œì¥
  - âœ… "ë³´ê´€í•¨ì— ë‹´ì•˜ì–´ìš”"
  - âŒ "ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤" (ìˆ˜ë™íƒœ, ë”±ë”±í•¨)

3. íˆ´íŒ
  - **ê¸€ì ìˆ˜**: ê³µë°± í¬í•¨ 20ì ì´ë‚´ ê¶Œì¥ (ìµœëŒ€ 36ì)
  - **1ë¬¸ì¥ ê¶Œì¥** (ê¼­ í•„ìš”í•œ ê²½ìš° ìµœëŒ€ 2ë¬¸ì¥)
  - **í•µì‹¬ í˜œíƒ ì¤‘ì‹¬**: ì‚¬ìš©ìê°€ ì–»ëŠ” í•µì‹¬ í˜œíƒì„ ì„¸ë ¨ë˜ê³  ë¾°ì¡±í•˜ê²Œ ì „ë‹¬
  - **ì‰¼í‘œ ì—°ê²°í˜• ë¬¸ì¥ ì§€ì–‘**: "~í•˜ê³ , ~í•˜ì„¸ìš”" ê°™ì€ ë³µí•© ë¬¸ì¥ ê¸ˆì§€
  - ì •ë³´ ì œê³µí˜• ì–´íˆ¬ (ëª…ë ¹í˜•ì´ë‚˜ ì§ˆë¬¸í˜•ë³´ë‹¤)
  - í•´ìš”ì²´ ê¸°ë³¸, ê°„ê²°ì„±ì„ ìœ„í•´ ëª…ì‚¬í˜• í—ˆìš©
  - ë¯¸ì‚¬ì—¬êµ¬ë‚˜ ìˆ˜ì‹ì–´ ìµœì†Œí™”
  - âœ… "ë¹„ìŠ·í•œ ìŒì•…ì„ ì¶”ì²œí•´ìš”" (12ì, í•µì‹¬ í˜œíƒë§Œ)
  - âœ… "ì¢‹ì•„ìš” í‘œì‹œí•œ ê³¡ ëª¨ìŒ" (12ì, ëª…ì‚¬í˜•)
  - âŒ "ì´ ê³¡ê³¼ ë¹„ìŠ·í•œ ìŒì•…ì„ ì°¾ì•„ì„œ ì¶”ì²œí•´ìš”" (20ì, ì •ë³´ ë‚˜ì—´)
  - âŒ "ì¬ìƒ ëª©ë¡ì„ í™•ì¸í•˜ê³ , ì›í•˜ëŠ” ê³¡ì„ ì„ íƒí•˜ì„¸ìš”" (25ì, ì‰¼í‘œ ì—°ê²°í˜•)

4. ì—ëŸ¬ ë©”ì‹œì§€
  - ì›ì¸ ì„¤ëª… + í•´ê²°ì±… ì œê³µ
  - FLO ê³¼ì‹¤ì¼ ë•Œë§Œ ì‚¬ê³¼
  - âœ… "ì—°ê²°ì´ ì›í™œí•˜ì§€ ì•Šì•„ìš”. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”"
  - âŒ "ì¼ì‹œì ì¸ ì˜¤ë¥˜ì…ë‹ˆë‹¤ (502)" (ì‹œìŠ¤í…œ ì¤‘ì‹¬ ì–¸ì–´)

ìš©ì–´ í†µì¼:
- íŠ¸ë™ â†’ ê³¡, ìŒì•…
- ì²­ì·¨, ìŠ¤íŠ¸ë¦¬ë° â†’ ë“£ê¸°, ê°ìƒ
- ì°œí•˜ê¸°, Like â†’ ì¢‹ì•„ìš”
- ì œê³µ ë¶ˆê°€ â†’ ì„œë¹„ìŠ¤ ì´ìš©ì´ ì–´ë ¤ì›Œìš”
`,

  [WritingContext.MARKETING]: `
[ë§ˆì¼€íŒ… ìƒì„¸ ì§€ì¹¨]

ì ìš© ë²”ìœ„: í‘¸ì‹œ ì•Œë¦¼, ë°°ë„ˆ, ì´ë²¤íŠ¸/í”„ë¡œëª¨ì…˜ ë¬¸êµ¬, ê´‘ê³  ìŠ¬ë¡œê±´

í•µì‹¬ íŠ¹ì„±:
- í¥ë¯¸ ìœ ë°œ: ì‚¬ìš©ìê°€ í´ë¦­í•˜ê³  ì‹¶ê²Œ ë§Œë“¦
- ëª…í™•í•œ í˜œíƒ: ë¬´ì—‡ì„ ì–»ì„ ìˆ˜ ìˆëŠ”ì§€ ë¶„ëª…íˆ í•¨
- ê¸´ê¸‰ì„±/í¬ì†Œì„±: í•„ìš”ì‹œ ì‹œê°„/ìˆ˜ëŸ‰ ì œí•œ ëª…ì‹œ
- FLOë‹¤ì›€ ìœ ì§€: ê³¼ë„í•œ ìƒì—…ì„±ë³´ë‹¤ ë¸Œëœë“œ í†¤ ìœ ì§€

ì»´í¬ë„ŒíŠ¸ë³„ ê°€ì´ë“œ:

1. í‘¸ì‹œ ì•Œë¦¼
  - íƒ€ì´í‹€: í•µì‹¬ ë©”ì‹œì§€ (20ì ì´ë‚´ ê¶Œì¥)
  - ë³¸ë¬¸: ìƒì„¸ ì„¤ëª… + í–‰ë™ ìœ ë„ (40ì ì´ë‚´)
  - âœ… "OOë‹˜, ì²« ë‹¬ ë¬´ë£Œ í˜œíƒ / ì§€ê¸ˆ ê°€ì…í•˜ë©´ í”„ë¦¬ë¯¸ì—„ì„ í•œ ë‹¬ ë¬´ë£Œë¡œ ì´ìš©í•  ìˆ˜ ìˆì–´ìš”"

2. ì´ë²¤íŠ¸/í”„ë¡œëª¨ì…˜
  - í˜œíƒ ìš°ì„  ë°°ì¹˜, ì¡°ê±´/ê¸°ê°„ ëª…ì‹œ, ê³¼ì¥ ê¸ˆì§€
  - âœ… "ì²« ë‹¬ ë¬´ë£Œ, ì–¸ì œë“  í•´ì§€ ê°€ëŠ¥"
  - âŒ "ì—­ëŒ€ê¸‰ í˜œíƒ!" (êµ¬ì²´ì„± ë¶€ì¡±)

ê¸ˆì§€ í‘œí˜„:
- "ì—­ëŒ€ê¸‰", "ì´ˆíŠ¹ê°€" â†’ "íŠ¹ë³„ í˜œíƒ", "í• ì¸"
- "ì ˆëŒ€", "ë°˜ë“œì‹œ" â†’ "ì¶”ì²œ", "ë†“ì¹˜ì§€ ë§ˆì„¸ìš”"
- "!!!!" â†’ ëŠë‚Œí‘œ 1ê°œ ë˜ëŠ” ìƒëµ
`,

  [WritingContext.CREATIVE]: `
[ë¸Œëœë”©/í¬ë¦¬ì—ì´í‹°ë¸Œ ìƒì„¸ ì§€ì¹¨]

ì ìš© ë²”ìœ„: ì˜¨ë³´ë”©, ì— í‹° ìŠ¤í…Œì´íŠ¸, ë¡œë”© ë¬¸êµ¬

í•µì‹¬ íŠ¹ì„±:
- ë¸Œëœë“œ í˜ë¥´ì†Œë‚˜: ëˆ„êµ¬ì—ê²Œë‚˜ í¸ê²¬ ì—†ê³  í•©ë¦¬ì ì¸, ì¹œêµ¬ ê°™ì€ ì¡´ì¬
- í•µì‹¬ í‚¤ì›Œë“œ: ê°€ë³ê²Œ, ë‚˜ë‹µê²Œ (Light, Me-like)
- ê°ì„± ì—°ê²°: ì‚¬ìš©ìì™€ ì •ì„œì  ìœ ëŒ€ê° í˜•ì„±
- ì°¨ë³„í™”: FLOë§Œì˜ ë…íŠ¹í•œ ëª©ì†Œë¦¬
- ì¼ê´€ì„±: ëª¨ë“  ì ‘ì ì—ì„œ ë™ì¼í•œ ë¸Œëœë“œ ê²½í—˜

ì»´í¬ë„ŒíŠ¸ë³„ ê°€ì´ë“œ:

1. ì˜¨ë³´ë”©
  - íƒ€ì´í‹€: í•µì‹¬ ê°€ì¹˜ ì œì•ˆ (ê°„ê²°í•˜ê³  ì„íŒ©íŠ¸ ìˆê²Œ)
  - ì„¤ëª…: êµ¬ì²´ì ì¸ í˜œíƒ/ê¸°ëŠ¥ ì„¤ëª… (1-2ë¬¸ì¥)
  - âœ… "ë‹¹ì‹ ì˜ ì·¨í–¥ì„ ì°¾ì•„ë“œë ¤ìš” / ì¢‹ì•„í•˜ëŠ” ìŒì•…ì„ ì•Œë ¤ì£¼ì‹œë©´, FLOê°€ ë”± ë§ëŠ” í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ë¥¼ ì¶”ì²œí•´ìš”"

2. ì— í‹° ìŠ¤í…Œì´íŠ¸
  - í˜„ì¬ ìƒíƒœ ì„¤ëª… + ê¸ì •ì  ì œì•ˆ
  - âœ… "ì•„ì§ ë³´ê´€í•œ ê³¡ì´ ì—†ì–´ìš”\nì¢‹ì•„í•˜ëŠ” ìŒì•…ì„ ë‹´ì•„ë³´ì„¸ìš”"
  - âŒ "ë°ì´í„° ì—†ìŒ" (ì‹œìŠ¤í…œ ì¤‘ì‹¬ ì–¸ì–´)

3. ë¡œë”© ë¬¸êµ¬
  - ì§§ê³  ê²½ì¾Œí•˜ê²Œ, ê¸°ëŒ€ê° ì¡°ì„±
  - âœ… "ìŒì•…ì„ ì¤€ë¹„í•˜ê³  ìˆì–´ìš”", "ì·¨í–¥ ì €ê²© í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ë¥¼ ì°¾ëŠ” ì¤‘ì´ì—ìš”"
  - âŒ "ë¡œë”© ì¤‘..." (ì‹œìŠ¤í…œ ìš©ì–´)

ë¸Œëœë“œ ë³´ì´ìŠ¤:
- ì¹œê·¼í•˜ì§€ë§Œ ì ë‹¹í•œ ê±°ë¦¬ê° ìœ ì§€
- ì „ë¬¸ì ì´ì§€ë§Œ ì–´ë µì§€ ì•Šê²Œ
- ë”°ëœ»í•˜ì§€ë§Œ ê³¼í•˜ì§€ ì•Šê²Œ
`,

  [WritingContext.BUSINESS]: `
[ë¹„ì¦ˆë‹ˆìŠ¤ ìƒì„¸ ì§€ì¹¨]

ì ìš© ë²”ìœ„: ê³µì§€ì‚¬í•­, ì •ì±…/ì•½ê´€, ë¹„ì¦ˆë‹ˆìŠ¤ ë©”ì¼, FAQ ë‹µë³€, ì‹œìŠ¤í…œ ì•Œë¦¼

í•µì‹¬ íŠ¹ì„±:
- ì •í™•ì„±: ëª¨í˜¸í•¨ ì—†ì´ ëª…í™•í•˜ê²Œ
- íˆ¬ëª…ì„±: ì¤‘ìš” ì •ë³´ë¥¼ ìˆ¨ê¸°ì§€ ì•ŠìŒ
- ì „ë¬¸ì„±: ì‹ ë¢°ê° ìˆëŠ” ì–´ì¡°
- ì¡´ì¤‘: ì‚¬ìš©ìë¥¼ ë°°ë ¤í•˜ëŠ” íƒœë„

ì»´í¬ë„ŒíŠ¸ë³„ ê°€ì´ë“œ:

1. ê³µì§€ì‚¬í•­
  - ì œëª©: í•µì‹¬ ë‚´ìš© ìš”ì•½ (ê°„ê²°í•˜ê²Œ)
  - ë³¸ë¬¸: 5W1H ì›ì¹™ (What, When, Where, Why, How)
  - âœ… "ì„œë¹„ìŠ¤ ì ê²€ ì•ˆë‚´ (1/15, 02:00-04:00)"

2. ì •ì±…/ì•½ê´€
  - í•©ë‹ˆë‹¤ì²´ ì‚¬ìš© (í•„ìˆ˜)
  - ì¡°í•­ ë²ˆí˜¸ ëª…ì‹œ, ì •ì˜ ëª…í™•í™”, ì˜ˆì™¸ ì‚¬í•­ ëª…ì‹œ
  - âœ… "ì œ3ì¡° (ì„œë¹„ìŠ¤ì˜ ì œê³µ)\n1. íšŒì‚¬ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•©ë‹ˆë‹¤..."

3. FAQ ë‹µë³€
  - í•µì‹¬ ë‹µë³€ â†’ ìƒì„¸ ì„¤ëª… â†’ ì¶”ê°€ ì•ˆë‚´
  - âœ… "ë„¤, ê°€ëŠ¥í•©ë‹ˆë‹¤.\nêµ¬ë§¤ í›„ 7ì¼ ì´ë‚´, ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•˜ì§€ ì•Šì€ ê²½ìš° ì „ì•¡ í™˜ë¶ˆì´ ê°€ëŠ¥í•´ìš”."

ì‚¬ê³¼ì™€ ì±…ì„:
- FLO ê³¼ì‹¤ì¸ ê²½ìš°: âœ… "ì„œë¹„ìŠ¤ ì¥ì• ë¡œ ë¶ˆí¸ì„ ë“œë ¤ ì£„ì†¡í•©ë‹ˆë‹¤"
- FLO ê³¼ì‹¤ì´ ì•„ë‹Œ ê²½ìš°: âœ… "ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ ì£¼ì„¸ìš”" (ë¶ˆí•„ìš”í•œ ì‚¬ê³¼ ì§€ì–‘)

ìš©ì–´ í†µì¼:
- ìœ ì €, ê³ ê° â†’ íšŒì›, ì´ìš©ì
- ê³¼ê¸ˆ, ì²­êµ¬ â†’ ê²°ì œ, êµ¬ë§¤
`
};

/**
 * ì»¨í…ìŠ¤íŠ¸ì— ë§ëŠ” ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ìƒì„±
 * ë§ˆìŠ¤í„° ë£° + ì¹´í…Œê³ ë¦¬ë³„ ë£° ì¡°í•©
 */
function buildSystemInstruction(context: WritingContext): string {
  const categoryRule = CATEGORY_RULES[context];

  if (categoryRule) {
    // ì¹´í…Œê³ ë¦¬ë³„ ë£°ì´ ìˆìœ¼ë©´ ë§ˆìŠ¤í„° ë£° + ì¹´í…Œê³ ë¦¬ ë£° ì¡°í•©
    return `${MASTER_RULES}\n\n${categoryRule}`;
  } else {
    // ì¹´í…Œê³ ë¦¬ë³„ ë£°ì´ ì—†ìœ¼ë©´ ë§ˆìŠ¤í„° ë£°ë§Œ ì‚¬ìš© (í´ë°±)
    console.log(`âš ï¸ ì¹´í…Œê³ ë¦¬ '${context}'ì— ëŒ€í•œ ìƒì„¸ ë£°ì´ ì—†ìŠµë‹ˆë‹¤. ë§ˆìŠ¤í„° ë£°ë§Œ ì ìš©í•©ë‹ˆë‹¤.`);
    return MASTER_RULES;
  }
}

// JSON ì¶”ì¶œ í—¬í¼ í•¨ìˆ˜ (ê°•í™”ëœ ë²„ì „ - í•œê¸€ ë”°ì˜´í‘œ ì²˜ë¦¬)
const extractJSON = (text: string): any => {
  try {
    let processText = text.trim();

    // 1. ë”°ì˜´í‘œ ì •ê·œí™” (ì „ê°/ë°˜ê° ë”°ì˜´í‘œ ë¬¸ì œ í•´ê²°)
    processText = processText
      .replace(/â€œ/g, '"').replace(/â€/g, '"')
      .replace(/â€˜/g, "'").replace(/â€™/g, "'")
      .replace(/ï½¢/g, '"').replace(/ï½£/g, '"');

    // 2. ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡ ì œê±° (ìˆëŠ” ê²½ìš°ì—ë§Œ)
    if (processText.includes('```')) {
      const codeBlockMatch = processText.match(/```(?:json)?([\s\S]*?)```/);
      if (codeBlockMatch && codeBlockMatch[1]) {
        processText = codeBlockMatch[1].trim();
      }
    }
    // 3. ê°€ì¥ ë°”ê¹¥ìª½ ì¤‘ê´„í˜¸ { } êµ¬ê°„ ì¶”ì¶œ (ìˆœìˆ˜ JSONë§Œ ë‚¨ê¸°ê¸°)
    const firstOpen = processText.indexOf('{');
    if (firstOpen !== -1) {
      processText = processText.substring(firstOpen);
      const lastCloseActual = processText.lastIndexOf('}');
      if (lastCloseActual !== -1) {
        processText = processText.substring(0, lastCloseActual + 1);
      }
    }

    // 4. ì˜ë¦° ì‘ë‹µ ë³µêµ¬ ë¡œì§ (ë” ì •êµí•˜ê²Œ)
    if (!processText.endsWith('}')) {
      // ì—´ë¦° ë”°ì˜´í‘œ ë‹«ê¸°
      const quoteCount = (processText.match(/"/g) || []).length;
      if (quoteCount % 2 !== 0) {
        processText += '"';
      }

      // í•„ìš”í•œ ë§Œí¼ ì¤‘ê´„í˜¸ ë‹«ê¸°
      const openBraces = (processText.match(/\{/g) || []).length;
      const closeBraces = (processText.match(/\}/g) || []).length;
      for (let i = 0; i < (openBraces - closeBraces); i++) {
        processText += '}';
      }
    }

    // 5. ìµœì¢… íŒŒì‹±
    const parsed = JSON.parse(processText);

    // 6. í•„ìˆ˜ í•„ë“œ ë³´ì¥ (UI í¬ë˜ì‹œ ë°©ì§€)
    if (parsed && typeof parsed === 'object') {
      if (!parsed.improvedText && parsed.text) parsed.improvedText = parsed.text;
      if (!parsed.alternatives) parsed.alternatives = [];
      if (!Array.isArray(parsed.alternatives)) parsed.alternatives = [parsed.alternatives];
    }

    return parsed;
  } catch (e) {
    console.error("âŒ JSON Parsing Failed:", e);
    // ê°€ì¥ ì›ì‹œì ì¸ í˜•íƒœì˜ ì‹œë„ (ì •ê·œì‹ìœ¼ë¡œ í•„ìš”í•œ ê°’ë§Œ ì¶”ì¶œ)
    try {
      const improvedMatch = text.match(/"improvedText"\s*:\s*"([^"]+)"/);
      if (improvedMatch) {
        return {
          improvedText: improvedMatch[1],
          alternatives: [],
          reasoning: "ì‘ë‹µ íŒŒì‹± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì—¬ í…ìŠ¤íŠ¸ë§Œ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤."
        };
      }
    } catch (innerE) { }
    return null;
  }
};

// ë©”ì¸ LLM í˜¸ì¶œ í•¨ìˆ˜ (ìë™ í´ë°±)
const callLLM = async (systemInstruction: string, userMessage: string): Promise<{ content: string; model: string }> => {
  if (!GEMINI_API_KEY) {
    throw new Error('Gemini API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
  }

  // 1ì°¨ ì‹œë„: Gemini 2.0 Flash
  try {
    console.log(`âœ¨ Connecting to ${PRIMARY_MODEL}...`);
    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${PRIMARY_MODEL}:generateContent?key=${GEMINI_API_KEY}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: `${systemInstruction}\n\n${userMessage}` }] }],
        generationConfig: {
          temperature: 0.8,
          topK: 40,
          topP: 0.95,
          maxOutputTokens: 2048,
          responseMimeType: "application/json"
        }
      })
    });

    if (response.ok) {
      const data = await response.json();
      if (data.candidates?.[0]?.content?.parts?.[0]?.text) {
        console.log(`âœ… AI ì‘ë‹µ ì„±ê³µ (${PRIMARY_MODEL})`);
        return { content: data.candidates[0].content.parts[0].text, model: PRIMARY_MODEL };
      }
    }

    // 503 ë˜ëŠ” ê¸°íƒ€ ì˜¤ë¥˜ ì‹œ í´ë°±
    console.log(`âš ï¸ ${PRIMARY_MODEL} ì‚¬ìš© ë¶ˆê°€, ${FALLBACK_MODEL}ë¡œ ì „í™˜...`);
  } catch (error) {
    console.log(`âš ï¸ ${PRIMARY_MODEL} ì˜¤ë¥˜, ${FALLBACK_MODEL}ë¡œ ì „í™˜...`);
  }

  // 2ì°¨ ì‹œë„: Gemini 1.5 Flash (í´ë°±)
  try {
    console.log(`âœ¨ Connecting to ${FALLBACK_MODEL}...`);
    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${FALLBACK_MODEL}:generateContent?key=${GEMINI_API_KEY}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: `${systemInstruction}\n\n${userMessage}` }] }],
        generationConfig: {
          temperature: 0.8,
          maxOutputTokens: 2048,
          responseMimeType: "application/json"
        }
      })
    });

    if (!response.ok) {
      const errText = await response.text();
      throw new Error(`AI ì„œë²„ ì˜¤ë¥˜: ${response.status} - ${errText}`);
    }

    const data = await response.json();
    if (data.candidates?.[0]?.content?.parts?.[0]?.text) {
      console.log(`âœ… AI ì‘ë‹µ ì„±ê³µ (${FALLBACK_MODEL})`);
      return { content: data.candidates[0].content.parts[0].text, model: FALLBACK_MODEL };
    }

    throw new Error("AI ì‘ë‹µ í˜•ì‹ì„ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
  } catch (error) {
    console.error('AI Service Error:', error);
    throw error;
  }
};

export const analyzeAndRefineText = async (
  currentText: string,
  context: WritingContext,
  tone: ToneLevel,
  customGuide: string,
  caseStudies: string,
  mode: WritingMode,
  imageData?: { data: string; mimeType: string },
  element?: string,
  guideAttachments?: Attachment[],
  caseAttachments?: Attachment[]
): Promise<AnalysisResult> => {

  const userMessage = `
    [ì‚¬ìš©ì ì…ë ¥ ì •ë³´]
    - í˜„ì¬ í…ìŠ¤íŠ¸: "${currentText}"
    - ì‘ì„± ëª¨ë“œ: ${mode === WritingMode.CREATE ? 'ì‹ ê·œ ì‘ì„±' : 'ê¸°ì¡´ ë¬¸êµ¬ êµì •'}
    - ìƒí™©(Context): ${context}
    ${element ? `- ìƒì„¸ ìš”ì†Œ: ${element}` : ''}
    - í†¤ì•¤ë§¤ë„ˆ ë‹¨ê³„: Lv.${tone} (ê°€ì´ë“œë¼ì¸ì˜ Lv.${tone} ì§€ì¹¨ì„ ì—„ê²©íˆ ì¤€ìˆ˜)

    [ì°¸ê³  ê°€ì´ë“œ ë° ì‚¬ë¡€]
    - ì»¤ìŠ¤í…€ ê°€ì´ë“œ: ${customGuide || 'ì—†ìŒ'}
    - ì°¸ê³  ì‚¬ë¡€: ${caseStudies || 'ì—†ìŒ'}
    ${imageData ? '- ì´ë¯¸ì§€ê°€ ì²¨ë¶€ë¨ (ì´ë¯¸ì§€ ë§¥ë½ì„ ê³ ë ¤í•˜ì—¬ ì œì•ˆ)' : ''}
    
    ${element?.toLowerCase().includes('íˆ´íŒ') || element?.toLowerCase().includes('tooltip') ? `
    **[íˆ´íŒ ì‘ì„± íŠ¹ë³„ ì§€ì¹¨ - ë§¤ìš° ì¤‘ìš”]**
    - ê¸€ì ìˆ˜: ê³µë°± í¬í•¨ 20ì ì´ë‚´ ê¶Œì¥ (ì ˆëŒ€ ìµœëŒ€ 36ì ì´ˆê³¼ ê¸ˆì§€)
    - í•µì‹¬ í˜œíƒë§Œ ì„¸ë ¨ë˜ê³  ë¾°ì¡±í•˜ê²Œ ì „ë‹¬ (ì •ë³´ ë‚˜ì—´ ê¸ˆì§€)
    - ì‰¼í‘œ ì—°ê²°í˜• ë¬¸ì¥ ì ˆëŒ€ ê¸ˆì§€ ("~í•˜ê³ , ~í•˜ì„¸ìš”" ê°™ì€ ë³µí•© ë¬¸ì¥ ì‚¬ìš© ë¶ˆê°€)
    - ë‹¨ì¼ ë¬¸ì¥ìœ¼ë¡œ ëª…í™•í•˜ê²Œ ì‘ì„±
    - ë¶ˆí•„ìš”í•œ ìˆ˜ì‹ì–´ ì œê±° ("ì´ ê¸°ëŠ¥ì€", "~ì„ í†µí•´" ë“±)
    ` : ''}

    [ìš”êµ¬ ì‚¬í•­]
    ì‚¬ìš©ì ì…ë ¥ì„ ë°”íƒ•ìœ¼ë¡œ FLO UX ë¼ì´íŒ… ê°€ì´ë“œë¥¼ ì¤€ìˆ˜í•˜ëŠ” **ìµœê³  í’ˆì§ˆì˜ ì°½ì˜ì ì¸ ë¬¸êµ¬**ë¥¼ ì œì•ˆí•˜ì„¸ìš”. ì›ë³¸ê³¼ ë„ˆë¬´ ìœ ì‚¬í•œ ë¬¸êµ¬ëŠ” í”¼í•˜ê³ , FLOì˜ 'ì„¸ë ¨ëœ ì´ì›ƒ' í˜ë¥´ì†Œë‚˜ë¥¼ ê·¹ëŒ€í™”í•  ìˆ˜ ìˆëŠ” ë°©í–¥ìœ¼ë¡œ ê³¼ê°í•˜ê²Œ ê°œì„ í•˜ì„¸ìš”.
    
    ë°˜ë“œì‹œ ë‹¤ìŒ í˜•ì‹ì˜ JSON ê°ì²´ í•˜ë‚˜ë§Œ ì¶œë ¥í•´ì•¼ í•©ë‹ˆë‹¤:
    1. improvedText: ê°€ì¥ ì¶”ì²œí•˜ëŠ” ë©”ì¸ ë¬¸êµ¬ (í•„ìˆ˜. ì…ë ¥ê°’ë³´ë‹¤ í›¨ì”¬ FLOë‹¤ìš´ í‘œí˜„ìœ¼ë¡œ ê°œì„ í•  ê²ƒ)
    2. alternatives: ê°ê¸° ë‹¤ë¥¸ ê´€ì (ë¸Œëœë“œ ê°•ì¡°í˜•, í–‰ë™ ìœ ë„í˜•, ê³µê° ì¤‘ì‹¬í˜• ë“±)ì„ ê°€ì§„ ëŒ€ì•ˆ ë¬¸êµ¬ 5ê°œ (ë°°ì—´, í•„ìˆ˜)
    3. reasoning: ì„ ì • ì´ìœ  (2ë¬¸ì¥ ì´ë‚´, í•„ìˆ˜)
       - **ë§¤ìš° ì¤‘ìš”**: "ì´ëª¨ì§€ë¥¼ ìµœì†Œí™”í–ˆë‹¤"ê±°ë‚˜ "Lv.N ì§€ì¹¨ì„ ì¤€ìˆ˜í–ˆë‹¤"ì™€ ê°™ì€ ì§€ì¹¨ ì´í–‰ì— ëŒ€í•œ ë©”íƒ€ ì„¤ëª…ì€ ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.
       - ì˜¤ì§ ë¬¸êµ¬ ì „ë‹¬ë ¥, ë¸Œëœë“œ ë³´ì´ìŠ¤ ë¶€í•© ì—¬ë¶€, ì‚¬ìš©ì ê´€ì ì—ì„œì˜ ê°œì„ ì  ë“± ë¬¸êµ¬ ìì²´ì— ëŒ€í•œ ì´ìœ ë§Œ ì‘ì„±í•˜ì„¸ìš”.

    ì¤‘ìš”: ëª¨ë“  í…ìŠ¤íŠ¸ëŠ” ìœ íš¨í•œ JSON ë¬¸ìì—´ì´ì–´ì•¼ í•©ë‹ˆë‹¤. í°ë”°ì˜´í‘œë¥¼ ì“°ê³ , ì¤„ë°”ê¿ˆì€ \nìœ¼ë¡œ ì´ìŠ¤ì¼€ì´í”„í•˜ì„¸ìš”.

    [ì¶œë ¥ JSON ì˜ˆì‹œ]
    {
      "improvedText": "ì¶”ì²œ í…ìŠ¤íŠ¸",
      "alternatives": ["ëŒ€ì•ˆ1", "ëŒ€ì•ˆ2", "ëŒ€ì•ˆ3", "ëŒ€ì•ˆ4", "ëŒ€ì•ˆ5"],
      "reasoning": "ê°€ì´ë“œë¼ì¸ ì¤€ìˆ˜ ì—¬ë¶€ ë° ì´ìœ "
    }
  `;

  try {
    const systemInstruction = buildSystemInstruction(context);
    const { content: rawResponse, model: usedModelName } = await callLLM(systemInstruction, userMessage);
    const result = extractJSON(rawResponse);

    if (!result || !result.improvedText) {
      throw new Error("AI ì‘ë‹µ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    }

    return {
      ...result,
      usedModel: usedModelName,
      alternatives: Array.isArray(result.alternatives) ? result.alternatives : []
    };
  } catch (error) {
    console.error("Analysis Error:", error);
    throw error;
  }
};

export const compareOptions = async (
  options: string[],
  context: WritingContext,
  customGuide: string,
  caseStudies: string,
  guideAttachments?: Attachment[],
  caseAttachments?: Attachment[]
): Promise<CompareResult> => {
  const optionsText = options.map((opt, i) => `Option ${i + 1}: "${opt}"`).join('\n');

  const prompt = `
    ë‹¤ìŒ ì—¬ëŸ¬ ê°€ì§€ ë¬¸êµ¬ ì˜µì…˜ì„ [FLO UX ë¼ì´íŒ… ê°€ì´ë“œ] ê¸°ì¤€ìœ¼ë¡œ ë¹„êµ ë¶„ì„í•˜ì—¬ ê°€ì¥ ì ì ˆí•œ í•˜ë‚˜ë¥¼ ê³¨ë¼ì£¼ì„¸ìš”.

    [ìƒí™© ì •ë³´]
    - ìƒí™©(Context): ${context}
    
    [ë¬¸êµ¬ ì˜µì…˜]
    ${optionsText}

    [ì°¸ê³  ê°€ì´ë“œ]
    - ì»¤ìŠ¤í…€ ê°€ì´ë“œ: ${customGuide || 'ì—†ìŒ'}
    - ì°¸ê³  ì‚¬ë¡€: ${caseStudies || 'ì—†ìŒ'}

    [ìš”êµ¬ ì‚¬í•­]
    ì–´ëŠ ìª½ì´ FLOì˜ ë¸Œëœë“œ ë³´ì´ìŠ¤(ì„¸ë ¨ëœ ì´ì›ƒ, ì¹œì ˆí•˜ì§€ë§Œ ë‹´ë°±í•˜ê²Œ)ì— ê°€ì¥ ë¶€í•©í•˜ë©° ì‚¬ìš©ì ì¹œí™”ì ì¸ê°€ìš”?
    
    ë°˜ë“œì‹œ ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”:
    {
      "winner": "Option N (ì˜ˆ: Option 1)",
      "reason": "ì„ íƒ ì´ìœ  ì„¤ëª… (ì§€ì¹¨ ì¤€ìˆ˜ ì—¬ë¶€ ë“± ë©”íƒ€ ì„¤ëª… ì œì™¸, ë¬¸êµ¬ ìì²´ì˜ ì¥ë‹¨ì  ì¤‘ì‹¬)",
      "suggestion": "ì¶”ê°€ ì œì•ˆì‚¬í•­(ë” ê°œì„ í•  ë¶€ë¶„ì´ ìˆë‹¤ë©´)"
    }
  `;

  try {
    const systemInstruction = buildSystemInstruction(context);
    const { content: rawResponse, model } = await callLLM(systemInstruction, prompt);
    const data = extractJSON(rawResponse);

    if (!data) {
      throw new Error("AI ì‘ë‹µì„ ë¶„ì„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    }
    data.usedModel = model;
    return data;
  } catch (error) {
    console.error("Comparison Error:", error);
    throw error;
  }
};

export const getConceptExplanation = async (topic: string): Promise<string> => {
  const prompt = `
    UX ë¼ì´íŒ… ê°œë… ì¤‘ "${topic}"ì— ëŒ€í•´ ì„¤ëª…í•´ì£¼ì„¸ìš”.
    ì´ˆë³´ìë„ ì´í•´í•˜ê¸° ì‰½ê²Œ ì„¤ëª…í•˜ê³ , í•„ìš”í•˜ë‹¤ë©´ ì¢‹ì€ ì˜ˆì‹œ(O)ì™€ ë‚˜ìœ ì˜ˆì‹œ(X)ë¥¼ ë“¤ì–´ì£¼ì„¸ìš”.
    ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ ì¶œë ¥í•´ì£¼ì„¸ìš”.
    `;

  try {
    // ê°œë… ì„¤ëª…ì€ ì¼ë°˜ì ì¸ UX ë¼ì´íŒ… ì§€ì‹ì´ë¯€ë¡œ ë§ˆìŠ¤í„° ë£°ë§Œ ì‚¬ìš©
    const { content } = await callLLM(MASTER_RULES, prompt);
    return content || "ì„¤ëª…ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
  } catch (error) {
    console.error("Concept Explanation Error:", error);
    return "ì„¤ëª…ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
  }
};

export const generateMoreAlternatives = async (
  text: string,
  context: WritingContext,
  tone: ToneLevel,
  customGuide: string,
  caseStudies: string,
  existingAlternatives: string[],
  element?: string,
  guideAttachments?: Attachment[],
  caseAttachments?: Attachment[]
): Promise<string[]> => {
  const prompt = `
  [ìƒí™© ì •ë³´]
  - ì›ë³¸ ë¬¸êµ¬: "${text}"
    - ìƒí™©(Context): ${context}
    ${element ? `- ìƒì„¸ ìš”ì†Œ: ${element}` : ''}
  - í†¤ì•¤ë§¤ë„ˆ ë‹¨ê³„: Lv.${tone}
  - ê¸°ì œì•ˆëœ ë¬¸êµ¬(ì¤‘ë³µ í”¼í•  ê²ƒ): ${existingAlternatives.join(', ')}

  [ì°¸ê³  ê°€ì´ë“œ]
    - ì»¤ìŠ¤í…€ ê°€ì´ë“œ: ${customGuide || 'ì—†ìŒ'}

  [ìš”ì²­ ì‚¬í•­]
    ìœ„ ì¡°ê±´ê³¼ FLOì˜ í†¤ì•¤ë§¤ë„ˆë¥¼ ìœ ì§€í•˜ë©´ì„œ, ê¸°ì¡´ì— ì œì•ˆëœ ê²ƒê³¼ ê²¹ì¹˜ì§€ ì•ŠëŠ” **ìƒˆë¡œìš´ ëŒ€ì•ˆ ë¬¸êµ¬ 5ê°€ì§€**ë¥¼ ì¶”ê°€ë¡œ ì œì•ˆí•´ì£¼ì„¸ìš”.
    - ë‹¨ìˆœíˆ ë‹¨ì–´ë¥¼ ë°”ê¾¸ëŠ” ìˆ˜ì¤€ì´ ì•„ë‹ˆë¼, ë¬¸ì¥ êµ¬ì¡°ë‚˜ ì–´ì¡°ë¥¼ ê³¼ê°í•˜ê²Œ ë¹„í‹€ì–´ ë‹¤ì–‘í•œ í˜ë¥´ì†Œë‚˜ë¥¼ ë³´ì—¬ì£¼ì„¸ìš”.
    - ì˜ˆ: (ë¸Œëœë“œ ê°•ì¡°í˜•, í–‰ë™ ìœ ë„í˜•, ìœ„íŠ¸ ìˆëŠ” í‘œí˜„, ê·¹ë„ë¡œ ê°„ê²°í•œ í‘œí˜„ ë“±)
    - 5ê°œë¥¼ ì°½ì˜ì ìœ¼ë¡œ ëª¨ë‘ ì±„ì›Œì£¼ì„¸ìš”.
    
    [ì¶œë ¥ í˜•ì‹]
    { "alternatives": ["ì¶”ê°€ ëŒ€ì•ˆ 1", "ì¶”ê°€ ëŒ€ì•ˆ 2", "ì¶”ê°€ ëŒ€ì•ˆ 3", "ì¶”ê°€ ëŒ€ì•ˆ 4", "ì¶”ê°€ ëŒ€ì•ˆ 5"] }
  `;

  try {
    const systemInstruction = buildSystemInstruction(context);
    const { content: rawResponse } = await callLLM(systemInstruction, prompt);
    const parsedResult = extractJSON(rawResponse);

    if (parsedResult && Array.isArray(parsedResult.alternatives)) {
      return parsedResult.alternatives;
    }
    // alternatives í‚¤ê°€ ì•„ë‹Œ ë°°ì—´ ìì²´ë¡œ ì™”ì„ ê²½ìš° ëŒ€ë¹„
    if (Array.isArray(parsedResult)) return parsedResult;

    return [];
  } catch (e) {
    console.error("Alternative Generation Error:", e);
    return [];
  }
};
