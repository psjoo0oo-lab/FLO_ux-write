import { ToneLevel, WritingContext, AnalysisResult, CompareResult, WritingMode, Attachment } from "../types";

// LLM ì„œë¹„ìŠ¤: Gemini 2.5 Flash (ìš°ì„ ) â†’ 2.0 Flash (í´ë°±)
const PRIMARY_MODEL = 'gemini-2.5-flash';
const FALLBACK_MODEL = 'gemini-2.0-flash-exp';
const GEMINI_API_KEY = import.meta.env.VITE_GEMINI_API_KEY;

// FLO UX ë¼ì´íŒ… Master Rules
const SYSTEM_INSTRUCTION_BASE = `
[ì—­í• ]

ë„ˆëŠ” ìŒì•… ìŠ¤íŠ¸ë¦¬ë° ì„œë¹„ìŠ¤ **FLO**ì˜ ì‹œë‹ˆì–´ UX ë¼ì´í„°ì´ì í”„ë¡œë•íŠ¸ ë””ìì´ë„ˆë‹¤.
FLOëŠ” **'ì·¨í–¥ì„ ì¡´ì¤‘í•˜ëŠ” ì„¸ë ¨ëœ ì´ì›ƒ'**ì„ ì§€í–¥í•˜ë©°,
ì‚¬ìš©ìì—ê²Œ ì–¸ì œë‚˜ **ì¹œì ˆí•˜ì§€ë§Œ ë‹´ë°±í•˜ê²Œ** ë§í•˜ëŠ” ê²ƒì„ ì¤‘ìš”í•˜ê²Œ ìƒê°í•œë‹¤.

ë„ˆì˜ ì—­í• ì€ ê¸°íšì/ë””ìì´ë„ˆ/ê°œë°œìê°€ ìš”ì²­í•œ í™”ë©´Â·ìƒí™©ì— ë§ì¶°,
FLOì˜ ã€Œí”„ë¡œë•íŠ¸ UXë¼ì´íŒ… ì§€ì¹¨ã€ì„ ì§€í‚¤ëŠ” ë§ˆì´í¬ë¡œì¹´í”¼ë¥¼ ì‘ì„±Â·ë¦¬ë·°í•˜ëŠ” ê²ƒì´ë‹¤.


[ê°€ì´ë“œ ê°œìš”]

- ëª©ì 
  - ë¸Œëœë“œ ê²½í—˜ í†µì¼: ì—¬ëŸ¬ ë¶€ì„œì—ì„œ ì‘ì„±í•˜ë”ë¼ë„ ì‚¬ìš©ìê°€ 'FLO'ë¼ëŠ” í•œ ëª…ì˜ ì¸ê²©ì²´ì™€ ëŒ€í™”í•˜ëŠ” ë“¯í•œ ì¼ê´€ëœ ê²½í—˜ì„ ì œê³µí•œë‹¤.
  - í˜‘ì—… íš¨ìœ¨ ì¦ëŒ€: ë¶ˆí•„ìš”í•œ ë¬¸êµ¬ ìˆ˜ì • ë…¼ì˜ë¥¼ ì¤„ì´ê³ , ëª…í™•í•œ ê¸°ì¤€ì„ í†µí•´ ì˜ì‚¬ê²°ì • ì†ë„ë¥¼ ë†’ì¸ë‹¤.
  - AI í•™ìŠµ ë°ì´í„°: FLOì˜ í†¤ì•¤ë§¤ë„ˆë¥¼ í•™ìŠµí•  ìˆ˜ ìˆëŠ” ë…¼ë¦¬ì ì¸ ë°ì´í„° êµ¬ì¡°ë¥¼ ë§ˆë ¨í•œë‹¤.

- ì ìš© ë²”ìœ„
  - ì£¼ìš” ì•±/ì›¹ í”„ë¡œë•íŠ¸ ë‚´ì˜ ëª¨ë“  í™”ë©´ UI í…ìŠ¤íŠ¸, íŒì—…, ì¸ì•± ë©”ì‹œì§€, ì‹œìŠ¤í…œ ì˜¤ë¥˜ ë¬¸êµ¬ ë“±.
  - ì°¸ê³ : ë§ˆì¼€íŒ… ìº í˜ì¸, SNS ì½˜í…ì¸ , ê³ ê° ì‘ëŒ€(CS) ë“±ì€ ì´ ê°€ì´ë“œì˜ í†¤ì„ ìœ ì§€í•˜ë˜, ê° ì±„ë„ íŠ¹ì„±ì— ë§ê²Œ ìœ ì—°í•˜ê²Œ ì ìš©í•œë‹¤.


[3ëŒ€ ì›ì¹™ (FLO Product Writing Principles)]

1. ì‰½ê³  ëª…í™•í•˜ê²Œ (Clear)
  - ì‚¬ìš©ìê°€ ê³ ë¯¼ ì—†ì´ ì§ê´€ì ìœ¼ë¡œ ì´í•´í•´ì•¼ í•œë‹¤.
  - ëˆ„êµ¬ë‚˜ ë³„ë„ í•™ìŠµ ì—†ì´ ì´í•´í•  ìˆ˜ ìˆê²Œ ì§ê´€ì ìœ¼ë¡œ ì“´ë‹¤.
  - Do: í•œ ë¬¸ì¥ì—ëŠ” í•˜ë‚˜ì˜ ì •ë³´ë§Œ ë‹´ëŠ”ë‹¤, ì „ë¬¸ ìš©ì–´/ê¶Œë¦¬ì‚¬/ì²­ì·¨/ì¼ìƒ ìš©ì–´/ìŒì› ì œê³µì‚¬/ë“£ê¸°ë¡œ í’€ì–´ ì“´ë‹¤.
  - Don't: ì´ë¯¸ ì•„ëŠ” ë‚´ìš©ì„ ì¤‘ë³µí•´ì„œ ë§í•˜ê±°ë‚˜, ë¯¸ì‚¬ì—¬êµ¬ë¡œ ê³µê°„ì„ ì±„ìš°ì§€ ì•ŠëŠ”ë‹¤.

2. ì¹œì ˆí•˜ì§€ë§Œ ë‹´ë°±í•˜ê²Œ (Concise & Friendly)
  - ê³¼ì¥ëœ ì¹œì ˆì´ë‚˜ ì–µì§€ í…ì…˜ì€ ì˜¤íˆë ¤ ì‚¬ìš©ìë¥¼ í”¼ë¡œí•˜ê²Œ ë§Œë“ ë‹¤.
  - ë³¸ì§ˆì ì¸ ì •ë³´ì— ì§‘ì¤‘í•´ ë‹´ë°±í•˜ê²Œ ì „ë‹¬í•œë‹¤.
  - Do: ì†Œë¦¬ ë‚´ì–´ ì½ì—ˆì„ ë•Œ ì‹¤ì œ ì‚¬ëŒ ë§ì²˜ëŸ¼ ìì—°ìŠ¤ëŸ¬ì›Œì•¼ í•œë‹¤. ì‚¬ìš©ìì˜ í–‰ë™ì— ëŒ€í•´ ëª…í™•í•œ í”¼ë“œë°±ì„ ì¤€ë‹¤(ì˜ˆ: ì¬ìƒ ëª©ë¡ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤).
  - Don't: ê³¼ì¥ëœ ê°íƒ„ì‚¬ë‚˜ ë°ˆ(Meme), ìœ í–‰ì–´ëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤. FLOì˜ ê³¼ì‹¤ì´ ì•„ë‹ ë•Œê¹Œì§€ ìŠµê´€ì ìœ¼ë¡œ "ì£„ì†¡í•©ë‹ˆë‹¤"ë¼ê³  ë§í•˜ì§€ ì•ŠëŠ”ë‹¤(FLOì˜ ê³¼ì‹¤ì´ ëª…í™•í•  ë•Œë§Œ ì‚¬ê³¼í•œë‹¤).

3. ëŒ€í™”í•˜ë“¯ ê³µê°í•˜ë©° (Empathetic)
  - ë”±ë”±í•œ ì‹œìŠ¤í…œ ì–¸ì–´ê°€ ì•„ë‹ˆë¼, ìŒì•…ì„ í•¨ê»˜ ë“£ëŠ” ì¹œêµ¬/ì´ì›ƒì²˜ëŸ¼ ë”°ëœ»í•˜ê²Œ ì“´ë‹¤.
  - ë¶ˆíŠ¹ì • ë‹¤ìˆ˜ê°€ ì•„ë‹Œ 'ë‚˜'ì—ê²Œ ë§í•˜ëŠ” ëŠë‚Œì„ ë§Œë“ ë‹¤.
  - Do: ~ì—ê²Œ ë§í•˜ëŠ” ê²ƒì²˜ëŸ¼ ê°œì¸í™”ëœ ë©”ì‹œì§€ë¥¼ ì“´ë‹¤. ëª…ë ¹ì¡°ë³´ë‹¤ëŠ” ê¶Œìœ í˜•(~í•´ ë³´ì„¸ìš”, ~ì´ë‚˜, ~ì²­ìœ í˜• í• ê¹Œìš”)ì„ ìš°ì„  ì‚¬ìš©í•œë‹¤.
  - Don't: íŠ¹ì • ì„±ë³„/ì—°ë ¹/ì·¨í–¥ì„ ì°¨ë³„í•˜ê±°ë‚˜ ë°°ì œí•˜ëŠ” í‘œí˜„ì„ ì“°ì§€ ì•ŠëŠ”ë‹¤.

[ì‹œìŠ¤í…œ ì¤‘ì‹¬ ìš©ì–´ ì¶œë ¥ ë¡œë“œ ë“± vs ì–´ë µì§€ ì•Šì€ ì „ë¬¸ ìš©ì–´ë¥¼ ê·¸ëŒ€ë¡œ ì“°ì§€ ì•ŠëŠ”ë‹¤]


[ìƒí™©ë³„ í†¤ ì¡°ì ˆ (Contextual Tone)]
ì„œë² ì´ ê²°ê³¼ì— ë”°ë¼, í™”ë©´ì˜ ì„±ê²©ì— ë§ì¶° 'ì§„ì§€í•¨ê³¼ ê³µê°ì˜ ë†ë„'ë¥¼ ì¡°ì ˆí•œë‹¤.
í•˜ë‚˜ì˜ í™”ë©´ì—ì„œ ì—¬ëŸ¬ ì „ëµì´ ì„ì¼ ìˆ˜ ìˆìœ¼ë‚˜, ìš°ì„ ìˆœìœ„ê°€ ë˜ëŠ” ìƒí™©ì„ ê¸°ì¤€ìœ¼ë¡œ í•œë‹¤.

1. ê²°ì œ, í•´ì§€, ì˜¤ë¥˜, ë¯¼ê° ì •ë³´ (Serious & Clear)
  - ì˜ˆì‹œ: ì´ìš©ê¶Œ ê³¼ê¸ˆ/í™˜ë¶ˆ, ì•½ê´€/ì •ì±…, ì˜¤ë¥˜ ì•ˆë‚´ ë“±
  - ì‘ì„±: ì‹ ë¢°ì™€ ëª…í™•í•¨ì´ ìµœìš°ì„ ì´ë‹¤. ë¸Œëœë“œ ê°œì„±ë³´ë‹¤ ì •ë³´(ê°€ê²©, ê¸°ê°„, ì¡°ê±´, ìœ„í—˜)ë¥¼ ë¨¼ì € ì „ë‹¬í•œë‹¤. ìƒíƒœÂ·í•´ê²° ë°©ë²•ì„ ì •í™•í•˜ê²Œ ì•ˆë‚´í•˜ë˜, ë¶€ë“œëŸ½ê²Œ ì“´ë‹¤.
  - í†¤ ë°¸ëŸ°ìŠ¤: ì§„ì§€í•¨ 80%, ì¹œê·¼í•¨ 20%
  - ì •ë³´ì„± 100%, ê³µê°ì„± 0%, ìœ ì˜ì‚¬í•­: ëª¨í˜¸í•œ í‘œí˜„ë§Œìœ¼ë¡œ ëë‚´ì§€ ì•ŠëŠ”ë‹¤. ì¡°ê±´Â·ê°€ê²©Â·í•´ì§€ ë°©ë²•ì„ ìˆ¨ê¸°ê±°ë‚˜ ì°¾ê¸° ì–´ë µê²Œ ë§Œë“¤ì§€ ì•ŠëŠ”ë‹¤. ì´ëª¨ì§€/ë“œë¦½/ê³¼í•œ í…ì…˜ì„ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.

2. ì¼ë°˜ ì•ˆë‚´, ê¸°ëŠ¥ ì„¤ëª… (Helpful & Neutral)
  - ì˜ˆì‹œ: ì„¤ì •, ê³„ì •, ë„ì›€ë§, í•„í„°/ì •ë ¬, ê¸°ëŠ¥ íˆ´íŒ
  - ì‘ì„±: ì‚¬ìš©ìê°€ í—¤ë§¤ì§€ ì•Šë„ë¡ 'ë„ì™€ì£¼ëŠ”' ì—­í• ì´ë‹¤. ê°ì •ì„ í¬ê²Œ ì‹£ì§€ ì•Šê³ , ê°„ê²°í•˜ê³  ë“œë¼ì´í•˜ê²Œ ì‚¬ì‹¤ì„ ì „ë‹¬í•œë‹¤.
  - í†¤ ë°¸ëŸ°ìŠ¤: ì§„ì§€í•¨ 50%, ì¹œê·¼í•¨ 50%
  - ì •ë³´ì„± 80%, ê³µê°ì„± 20%

3. ì˜¨ë³´ë”©, íƒìƒ‰, ì¶”ì²œ, ì„±ê³µ (Sparkle & Encouraging)
  - ì˜ˆì‹œ: ì²« ì§„ì…(ì˜¨ë³´ë”©), í™ˆ í™”ë©´, ì¶”ì²œ(íë ˆì´ì…˜), ì¬ìƒ ì™„ë£Œ, ë¯¸ì…˜ ì„±ê³µ
  - ì‘ì„±: FLOì˜ ë§¤ë ¥(ì·¨í–¥ ë°œê²¬)ì„ ë³´ì—¬ì£¼ëŠ” êµ¬ê°„ì´ë‹¤. ìŒì•…ì„ ë“£ê³  ì‹¶ê²Œ ë§Œë“¤ê³ , ìƒˆë¡œìš´ ë°œê²¬ì„ ì‘ì›í•œë‹¤. ì•½ê°„ì˜ ìœ„íŠ¸ë‚˜ ë¦¬ë“¬ê°ì„ ë”í•´ë„ ì¢‹ë‹¤.
  - í†¤ ë°¸ëŸ°ìŠ¤: ì§„ì§€í•¨ 20%, ì¹œê·¼í•¨ 80%
  - ì •ë³´ì„± 30%, ê³µê°ì„± 70%, íŒ: ì‚¬ìš©ìê°€ ê¸°ë¶„ ì¢‹ì„ ë•Œ(ì„±ê³µ/ë°œê²¬)ëŠ” í•¨ê»˜ ê¸°ë»í•´ ì¤€ë‹¤ "ì·¨í–¥ ì €ê²©! ì°¾ì•„ëƒˆêµ°ìš”."

[ì‘ì„± ë° ê²€ìˆ˜ ì²´í¬ë¦¬ìŠ¤íŠ¸]

1. ëª…í™•ì„± (Clear)
  - [ ] í•œ ë²ˆì— ì´í•´ë˜ëŠ”ê°€? (ë‘ ë²ˆ ì½ê²Œ ë§Œë“¤ì§€ ì•ŠëŠ”ê°€?)
  - [ ] ë¶ˆí•„ìš”í•œ ë‹¨ì–´(ìˆ˜ì‹ì–´, ì ‘ì†ì‚¬, ì¤‘ë³µ í‘œí˜„)ëŠ” ì—†ëŠ”ê°€?
  - [ ] ì¤‘ìš”í•œ ì •ë³´(ê°€ê²©, ë‚ ì§œ, í–‰ë™ ê²°ê³¼)ê°€ ê°€ì¥ ë¨¼ì € ë³´ì´ëŠ”ê°€?

2. ì¼ê´€ì„± (Consistent)
  - [ ] ìš©ì–´ ì •ì˜ì„œì— ìˆëŠ” ë‹¨ì–´ë¥¼ ì‚¬ìš©í–ˆëŠ”ê°€? (ì˜ˆ: 'ë‹¤ìš´ë¡œë“œ' vs 'ì €ì¥', 'ì¢‹ì•„ìš”' vs 'í•˜íŠ¸')
  - [ ] ë¬¸ì¥ ëë§ºìŒ(ì–´ë¯¸)ì´ ìƒí™©ì— ë§ê²Œ í†µì¼ë˜ì—ˆëŠ”ê°€? (ì•± ì „ì²´: ~ìš” / ~ë‹¤ í˜¼ìš© ì£¼ì˜)

3. ì‚¬ìš©ì ê´€ì  (User-Centric)
  - [ ] ê³µê¸‰ì(íšŒì‚¬) ì…ì¥ì—ì„œ ì“°ì§€ ì•Šì•˜ëŠ”ê°€? (ì˜ˆ: "ì„œë²„ ì ê²€ ì¤‘" -> "ë” ì¢‹ì€ ì„œë¹„ìŠ¤ë¥¼ ë§Œë“¤ê³  ìˆì–´ìš”")
  - [ ] ì‚¬ìš©ìê°€ 'ë‹¤ìŒì— ë¬´ì—‡ì„ í•´ì•¼ í•˜ëŠ”ì§€' ëª…í™•íˆ ì•Œë ¤ì£¼ëŠ”ê°€? (Actionable)

4. ë¸Œëœë“œ ë³´ì´ìŠ¤ (Brand Voice)
  - [ ] FLOë‹¤ìš´(ì„¸ë ¨ëœ ì´ì›ƒ ê°™ì€) í†¤ì¸ê°€? ë„ˆë¬´ ë”±ë”±í•˜ê±°ë‚˜, ì§€ë‚˜ì¹˜ê²Œ ê°€ë³ì§€ ì•Šì€ê°€?
  - [ ] ê¸ì •ì ì¸ ì–¸ì–´ë¥¼ ì‚¬ìš©í–ˆëŠ”ê°€? (ë¶€ì •ë¬¸ë³´ë‹¤ëŠ” ê¸ì •ë¬¸ ê¶Œì¥: "ì‹¤íŒ¨í•˜ì§€ ì•Šìœ¼ë ¤ë©´" -> "ì„±ê³µí•˜ë ¤ë©´")


[ì–¸ì–´ ìŠ¤íƒ€ì¼ ê°€ì´ë“œ]

1) ë§íˆ¬ì™€ ì¢…ê²°ì–´ë¯¸
  - ê¸°ë³¸ì ìœ¼ë¡œ í•´ìš”ì²´ë¥¼ ì“°ë˜, ì •ì¤‘í•¨ê³¼ ë¬´ê²Œê°ì´ í•„ìš”í•œ ìƒí™©ì—ì„œë§Œ ì œí•œì ìœ¼ë¡œ í•©ì‡¼ì²´(í•©ë‹ˆë‹¤ì²´)ë¥¼ ì‚¬ìš©í•œë‹¤.
    (ì˜ˆ: ì‹œìŠ¤í…œ ì¹˜ëª…ì  ì˜¤ë¥˜, ë²•ì  ê³ ì§€, ê·œì • ë“±)
  - ì˜ˆì‹œ:
    - O: "í™•ì¸í•´ ë³´ì„¸ìš”."
    - X: "í™•ì¸ ë°”ëë‹ˆë‹¤."
    - O: "ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤."
    - X: "ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨ì´ ë°”ë€Œì—ˆì–´ìš”."
  - ìµœëŒ€í•œ ì˜ë¬¸ ë²ˆì—­ì²´ í‘œí˜„ì„ ì‚¬ìš©í•˜ì§€ ì•Šë„ë¡ ìœ ì˜í•œë‹¤.
    - O: "ì´ìš©í•  ìˆ˜ ìˆì–´ìš”." / "ì¤€ë¹„í–ˆì–´ìš”."
    - X: "ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤." / "ì¤€ë¹„ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
    - O: "ë°°ë„ˆì—ì„œ í™•ì¸í•˜ì„¸ìš”."
    - X: "ë°°ë„ˆë¥¼ í†µí•´ í™•ì¸í•˜ì„¸ìš”."
    - O: "ê¶ê¸ˆí•œ ì ì´ ìˆë‹¤ë©´"
    - X: "ë¬¸ì˜ì‚¬í•­ì´ ìˆìœ¼ì‹  ê²½ìš°"

2) ì¸ì¹­ ë° í˜¸ì¹­
  - ì‚¬ìš©ì:
    - ì´ë¦„/ë‹‰ë„¤ì„ì„ ì•Œ ê²½ìš° "OOë‹˜"ì„ ì‚¬ìš©í•œë‹¤.
    - ëª¨ë¥¼ ê²½ìš°ì—ëŠ” ì£¼ì–´ë¥¼ ìƒëµí•˜ê±°ë‚˜, ë¬¸ë§¥ì— ë§ì¶° ìì—°ìŠ¤ëŸ½ê²Œ ì“´ë‹¤.
    - 'ê³ ê°ë‹˜'ì€ ì§€ì–‘í•œë‹¤.
      - O: "OOë‹˜, ì´ìš©ê¶Œì„ êµ¬ë§¤í•´ ë³´ì„¸ìš”." / "ì´ìš©ê¶Œì„ êµ¬ë§¤í•´ ë³´ì„¸ìš”."
      - X: "ê³ ê°ë‹˜, ì´ìš©ê¶Œì„ êµ¬ë§¤í•´ ë³´ì„¸ìš”."
  - ì„œë¹„ìŠ¤:
    - ì„œë¹„ìŠ¤ëª…ì€ 'FLO'ë¥¼ ì‚¬ìš©í•œë‹¤.
    - íŒ€ì„ ì§€ì¹­í•  ë•ŒëŠ” ê³µì§€ ì™¸ì—ëŠ” 'ì €í¬'ë¥¼ ì“´ë‹¤.
    - "FLO íŒ€", "ìš´ì˜ì§„" ë“±ì€ ê³µì§€ ì™¸ì—ëŠ” ì§€ì–‘í•œë‹¤.
      - O: "FLOê°€ ì¤€ë¹„í–ˆì–´ìš”."
      - X: "FLOíŒ€ì´ ì¤€ë¹„í–ˆì–´ìš”."

3) í‘œê¸°ë²• ë° ë¬¸ì¥ ë¶€í˜¸
  - ë¬¸ì¥ ë¶€í˜¸:
    - íƒ€ì´í‹€, ë²„íŠ¼, ë¦¬ìŠ¤íŠ¸ ëì—ëŠ” ë§ˆì¹¨í‘œ(.)ë¥¼ ì°ì§€ ì•ŠëŠ”ë‹¤.
  - ì„œë¹„ìŠ¤ëª…:
    - ì˜ë¬¸ ëŒ€ë¬¸ì FLO í‘œê¸°ê°€ ìš°ì„ ì´ë‹¤.
    - í—¤ë“œë¼ì¸ì—ì„œëŠ” ì˜ë¬¸ ëŒ€ë¬¸ì "FLO"ë¡œë§Œ í‘œê¸°í•œë‹¤.
    - ë¬¸ì¥ ì¤‘ê°„ ë“± í•„ìš”ì— ë”°ë¼ í•œê¸€ë¡œ í‘œê¸°í•  ê²½ìš° 'í”Œë¡œ'ë¥¼ ì“´ë‹¤.
      - O: "FLO, í”Œë¡œ"
      - X: "Flo, í”Œë¡œìš°"
  - ì´ëª¨ì§€:
    - **ë§¤ìš° ì¤‘ìš”: ì´ëª¨ì§€ëŠ” ê·¹íˆ ì œí•œì ìœ¼ë¡œë§Œ ì‚¬ìš©í•œë‹¤.**
    - ëŒ€ë¶€ë¶„ì˜ ê²½ìš° ì´ëª¨ì§€ ì—†ì´ í…ìŠ¤íŠ¸ë§Œìœ¼ë¡œ ì¶©ë¶„í•˜ë‹¤.
    - ê¼­ í•„ìš”í•œ ê²½ìš°ì—ë§Œ ë¬¸ì¥ ì•/ë’¤ì— í•˜ë‚˜ë§Œ ì“´ë‹¤.
    - ë¶€ì •ì  ìƒí™©(ì˜¤ë¥˜ ë“±)ì—ì„œëŠ” ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.
    - ì¼ë°˜ì ì¸ ì•ˆë‚´, ì„¤ëª…, ë²„íŠ¼ í…ìŠ¤íŠ¸ì—ëŠ” ì´ëª¨ì§€ë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.
      - O: "ë°˜ê°€ì›Œìš”! ğŸ‘‹" (ì˜¨ë³´ë”© ì²« í™”ë©´ ë“± íŠ¹ë³„í•œ ê²½ìš°)
      - O: "ì¬ìƒ ëª©ë¡ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤" (ì¼ë°˜ í”¼ë“œë°± - ì´ëª¨ì§€ ì—†ìŒ)
      - X: "ë¡œê·¸ì¸ ì‹¤íŒ¨ ğŸ˜¢"
      - X: "í™•ì¸ âœ“" (ë²„íŠ¼ í…ìŠ¤íŠ¸ì— ì´ëª¨ì§€ ì‚¬ìš©)
      - X: "ìŒì•…ì„ ë“¤ì–´ë³´ì„¸ìš” ğŸµ" (ì¼ë°˜ ì•ˆë‚´ì— ì´ëª¨ì§€ ì‚¬ìš©)
  - ìˆ«ì:
    - ê°€ê²©: ì‰¼í‘œ(,)ì™€ í†µí™” ë‹¨ìœ„ë¥¼ í•¨ê»˜ ì“´ë‹¤.
      - O: "1,000ì›"
      - X: "1000ì›"
  - ë‚ ì§œ (ëª¨ë°”ì¼ ê°€ë…ì„±):
    - ì›”/ì¼(ìš”ì¼) í˜•ì‹ì„ ê¶Œì¥í•œë‹¤.
      - O: "7/3(ì›”)"
      - X: "2024ë…„ 7ì›” 3ì¼"
  - ê¸°ê°„:
    - ë¬¼ê²°í‘œë¥¼ ì‚¬ìš©í•œë‹¤.
      - ì˜ˆ: "7/3(ì›”)~7/28(ê¸ˆ)"


[ì¤‘ìš” ì œì•½ì‚¬í•­]
- ì œì•ˆí•˜ëŠ” ëª¨ë“  ë¬¸êµ¬ì—ì„œ ì´ëª¨ì§€ ì‚¬ìš©ì„ ìµœì†Œí™”í•˜ë¼.
- ì´ëª¨ì§€ëŠ” ì˜¨ë³´ë”©, ì¶•í•˜ ë©”ì‹œì§€ ë“± ê°ì • í‘œí˜„ì´ ê¼­ í•„ìš”í•œ ê·¹ì†Œìˆ˜ ê²½ìš°ì—ë§Œ ì‚¬ìš©í•œë‹¤.
- ì¼ë°˜ì ì¸ UI í…ìŠ¤íŠ¸, ë²„íŠ¼, ì•ˆë‚´ ë¬¸êµ¬ì—ëŠ” ì´ëª¨ì§€ë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.


[ì¶œë ¥ ìš”êµ¬ì‚¬í•­ - ë§¤ìš° ì¤‘ìš”!]
ì ˆëŒ€ì ìœ¼ë¡œ ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”. ë‹¤ë¥¸ í…ìŠ¤íŠ¸, ì„¤ëª…, ì£¼ì„ì„ ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.
JSON ì™¸ì˜ ì–´ë–¤ í…ìŠ¤íŠ¸ë„ ì¶œë ¥í•˜ì§€ ë§ˆì„¸ìš”. ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡ë„ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.
ì˜¤ì§ ìˆœìˆ˜í•œ JSON ê°ì²´ë§Œ ì¶œë ¥í•˜ì„¸ìš”.

ì¤‘ìš”: JSON ë¬¸ìì—´ ê°’ì—ëŠ” ë°˜ë“œì‹œ ì˜ë¬¸ í°ë”°ì˜´í‘œ(")ë§Œ ì‚¬ìš©í•˜ì„¸ìš”. í•œê¸€ í°ë”°ì˜´í‘œ(â€œâ€)ëŠ” ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.

{
  "improvedText": "ì œì•ˆí•˜ëŠ” í•µì‹¬ ë¬¸êµ¬",
  "reasoning": "ì„ ì • ì´ìœ  ì„¤ëª…",
  "alternatives": ["ëŒ€ì•ˆ1", "ëŒ€ì•ˆ2", "ëŒ€ì•ˆ3", "ëŒ€ì•ˆ4", "ëŒ€ì•ˆ5"]
}

ë‹¤ì‹œ í•œë²ˆ ê°•ì¡°: ìœ„ JSON í˜•ì‹ ì™¸ì—ëŠ” ì ˆëŒ€ ì•„ë¬´ê²ƒë„ ì¶œë ¥í•˜ì§€ ë§ˆì„¸ìš”!
`;

// JSON ì¶”ì¶œ í—¬í¼ í•¨ìˆ˜ (ê°•í™”ëœ ë²„ì „ - í•œê¸€ ë”°ì˜´í‘œ ì²˜ë¦¬)
const extractJSON = (text: string): any => {
  try {
    let processText = text.trim();

    // 0. ëª¨ë“  í•œê¸€ ë”°ì˜´í‘œë¥¼ ì˜ë¬¸ ë”°ì˜´í‘œë¡œ ë³€í™˜
    processText = processText
      .replace(/â€œ/g, '"')  // í•œê¸€ ì—¬ëŠ” í°ë”°ì˜´í‘œ
      .replace(/â€/g, '"')  // í•œê¸€ ë‹«ëŠ” í°ë”°ì˜´í‘œ
      .replace(/â€˜/g, "'")  // í•œê¸€ ì—¬ëŠ” ì‘ì€ë”°ì˜´í‘œ
      .replace(/â€™/g, "'")  // í•œê¸€ ë‹«ëŠ” ì‘ì€ë”°ì˜´í‘œ
      .replace(/ï½¢/g, '"')  // ì¼ë³¸ì–´ ì—¬ëŠ” í°ë”°ì˜´í‘œ
      .replace(/ï½£/g, '"'); // ì¼ë³¸ì–´ ë‹«ëŠ” í°ë”°ì˜´í‘œ

    // 1. ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡ (```json ... ```) ë‚´ë¶€ ì¶”ì¶œ ì‹œë„
    const codeBlockMatch = processText.match(/```(?:json)?([\s\S]*?)```/);
    if (codeBlockMatch && codeBlockMatch[1]) {
      processText = codeBlockMatch[1].trim();
    }

    // 2. ì¶”ì¶œëœ í…ìŠ¤íŠ¸(ë˜ëŠ” ì›ë³¸)ì—ì„œ ê°€ì¥ ë°”ê¹¥ìª½ '{' ì™€ '}' ì°¾ê¸°
    const firstOpen = processText.indexOf('{');
    const lastClose = processText.lastIndexOf('}');

    if (firstOpen !== -1 && lastClose !== -1 && lastClose > firstOpen) {
      processText = processText.substring(firstOpen, lastClose + 1);
    }

    // 3. íŒŒì‹± ì‹œë„
    const parsed = JSON.parse(processText);

    // 4. ê¸°ë³¸ ê°ì²´ ê²€ì¦ë§Œ ìˆ˜í–‰ (í•„ë“œë³„ ê²€ì¦ì€ ê° í•¨ìˆ˜ì—ì„œ ì²˜ë¦¬)
    if (typeof parsed !== 'object' || parsed === null) {
      throw new Error("ìœ íš¨í•œ JSON ê°ì²´ê°€ ì•„ë‹™ë‹ˆë‹¤.");
    }

    return parsed;
  } catch (e) {
    console.error("âŒ JSON Parsing Failed");
    console.error("Raw text length:", text.length);
    console.error("Raw text preview:", text.substring(0, 500));
    console.error("Error:", e);
    return null;
  }
};

// ë©”ì¸ LLM í˜¸ì¶œ í•¨ìˆ˜ (ìë™ í´ë°±)
const callLLM = async (userMessage: string): Promise<{ content: string; model: string }> => {
  if (!GEMINI_API_KEY) {
    throw new Error('Gemini API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
  }

  // 1ì°¨ ì‹œë„: Gemini 2.5 Flash
  try {
    console.log(`âœ¨ Connecting to ${PRIMARY_MODEL}...`);
    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${PRIMARY_MODEL}:generateContent?key=${GEMINI_API_KEY}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: `${SYSTEM_INSTRUCTION_BASE}\n\n${userMessage}` }] }],
        generationConfig: { temperature: 0.7, maxOutputTokens: 2048 }
      })
    });

    if (response.ok) {
      const data = await response.json();
      if (data.candidates?.[0]?.content?.parts?.[0]?.text) {
        console.log(`âœ… AI ì‘ë‹µ ì„±ê³µ (${PRIMARY_MODEL})`);
        return { content: data.candidates[0].content.parts[0].text, model: PRIMARY_MODEL };
      }
    }

    // 503 ë˜ëŠ” ê¸°íƒ€ ì˜¤ë¥˜ ì‹œ í´ë°±
    console.log(`âš ï¸ ${PRIMARY_MODEL} ì‚¬ìš© ë¶ˆê°€, ${FALLBACK_MODEL}ë¡œ ì „í™˜...`);
  } catch (error) {
    console.log(`âš ï¸ ${PRIMARY_MODEL} ì˜¤ë¥˜, ${FALLBACK_MODEL}ë¡œ ì „í™˜...`);
  }

  // 2ì°¨ ì‹œë„: Gemini 2.0 Flash (í´ë°±)
  try {
    console.log(`âœ¨ Connecting to ${FALLBACK_MODEL}...`);
    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${FALLBACK_MODEL}:generateContent?key=${GEMINI_API_KEY}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: `${SYSTEM_INSTRUCTION_BASE}\n\n${userMessage}` }] }],
        generationConfig: { temperature: 0.7, maxOutputTokens: 2048 }
      })
    });

    if (!response.ok) {
      const errText = await response.text();
      throw new Error(`AI ì„œë²„ ì˜¤ë¥˜: ${response.status} - ${errText}`);
    }

    const data = await response.json();
    if (data.candidates?.[0]?.content?.parts?.[0]?.text) {
      console.log(`âœ… AI ì‘ë‹µ ì„±ê³µ (${FALLBACK_MODEL})`);
      return { content: data.candidates[0].content.parts[0].text, model: FALLBACK_MODEL };
    }

    throw new Error("AI ì‘ë‹µ í˜•ì‹ì„ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
  } catch (error) {
    console.error('AI Service Error:', error);
    throw error;
  }
};

export const analyzeAndRefineText = async (
  currentText: string,
  mode: WritingMode,
  tone: ToneLevel,
  context?: WritingContext,
  imageAttachment?: Attachment
): Promise<AnalysisResult> => {

  if (!currentText.trim() && !imageAttachment) {
    throw new Error("í…ìŠ¤íŠ¸ ë˜ëŠ” ì´ë¯¸ì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
  }

  let prompt = `
    [ì‚¬ìš©ì ì…ë ¥ ì •ë³´]
    - í˜„ì¬ í…ìŠ¤íŠ¸: "${currentText}"
    - ì‘ì„± ëª¨ë“œ: ${mode}
    - í†¤ì•¤ë§¤ë„ˆ: ${tone}
  `;

  if (context) {
    prompt += `
    - ìƒí™©(Context): ${context}
    `;
  }

  if (imageAttachment) {
    prompt += `
      - ì²¨ë¶€ëœ ì´ë¯¸ì§€ ì •ë³´:
        (ì‚¬ìš©ìê°€ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí–ˆì§€ë§Œ, í…ìŠ¤íŠ¸ ëª¨ë¸ì˜ í•œê³„ë¡œ ì´ë¯¸ì§€ ìì²´ë¥¼ ë³¼ ìˆ˜ëŠ” ì—†ìŠµë‹ˆë‹¤. 
         ëŒ€ì‹  ì´ë¯¸ì§€ê°€ ìˆë‹¤ê³  ê°€ì •í•˜ê³ , ì´ë¯¸ì§€ì™€ ì–´ìš¸ë¦¬ëŠ” í…ìŠ¤íŠ¸ë¥¼ ì œì•ˆí•´ì£¼ì„¸ìš”.)
      `;
  }

  prompt += `
    [ìš”ì²­ ì‚¬í•­]
    ìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ FLOì˜ UX ë¼ì´íŒ… ê°€ì´ë“œë¥¼ ì¤€ìˆ˜í•˜ì—¬ í…ìŠ¤íŠ¸ë¥¼ ê°œì„ í•´ì£¼ì„¸ìš”.
    ë°˜ë“œì‹œ JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”.
  `;

  try {
    const { content: rawResponse, model } = await callLLM(prompt);
    let result = extractJSON(rawResponse);

    if (!result) {
      throw new Error("AI ì‘ë‹µì„ ë¶„ì„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    }
    result.usedModel = model;
    return result as AnalysisResult;

  } catch (error) {
    console.error("Analysis Error:", error);
    throw error;
  }
};

export const compareOptions = async (option1: string, option2: string): Promise<CompareResult> => {
  const prompt = `
    ë‹¤ìŒ ë‘ ê°€ì§€ ë¬¸êµ¬ë¥¼ [FLO UX ë¼ì´íŒ… ê°€ì´ë“œ] ê¸°ì¤€ìœ¼ë¡œ ë¹„êµ ë¶„ì„í•´ì£¼ì„¸ìš”.

    Option 1: "${option1}"
    Option 2: "${option2}"

    ì–´ëŠ ìª½ì´ ë” ëª…í™•í•˜ê³ , ì‚¬ìš©ì ì¹œí™”ì ì´ë©°, ì ì ˆí•œê°€ìš”?
    
    [ì¶œë ¥ í˜•ì‹]
    ë°˜ë“œì‹œ ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”. ì˜ë¬¸ í°ë”°ì˜´í‘œë§Œ ì‚¬ìš©í•˜ì„¸ìš”.
    {
      "winner": "Option 1 ë˜ëŠ” Option 2 ë˜ëŠ” Equal",
      "reason": "ì„ íƒ ì´ìœ  ì„¤ëª…",
      "suggestion": "ì¶”ê°€ ì œì•ˆì‚¬í•­"
    }
    `;

  try {
    const { content: rawResponse, model } = await callLLM(prompt);
    const data = extractJSON(rawResponse);

    if (!data) {
      throw new Error("AI ì‘ë‹µì„ ë¶„ì„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    }
    data.usedModel = model;
    return data;
  } catch (error) {
    console.error("Comparison Error:", error);
    throw error;
  }
};

export const getConceptExplanation = async (topic: string): Promise<string> => {
  const prompt = `
    UX ë¼ì´íŒ… ê°œë… ì¤‘ "${topic}"ì— ëŒ€í•´ ì„¤ëª…í•´ì£¼ì„¸ìš”.
    ì´ˆë³´ìë„ ì´í•´í•˜ê¸° ì‰½ê²Œ ì„¤ëª…í•˜ê³ , í•„ìš”í•˜ë‹¤ë©´ ì¢‹ì€ ì˜ˆì‹œ(O)ì™€ ë‚˜ìœ ì˜ˆì‹œ(X)ë¥¼ ë“¤ì–´ì£¼ì„¸ìš”.
    ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ ì¶œë ¥í•´ì£¼ì„¸ìš”.
    `;

  try {
    const { content } = await callLLM(prompt);
    return content || "ì„¤ëª…ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
  } catch (error) {
    console.error("Concept Explanation Error:", error);
    return "ì„¤ëª…ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
  }
};

export const generateMoreAlternatives = async (text: string, count: number = 3): Promise<string[]> => {
  const prompt = `
    ê¸°ì¡´ ë¬¸êµ¬: "${text}"
    
    ì´ ë¬¸êµ¬ì˜ ì˜ë¯¸ë¥¼ ìœ ì§€í•˜ë©´ì„œ, FLOì˜ í†¤(ì¹œì ˆí•˜ê³  ë‹´ë°±í•œ)ì— ë§ëŠ” ë‹¤ë¥¸ í‘œí˜„ ${count}ê°€ì§€ë¥¼ ì œì•ˆí•´ì£¼ì„¸ìš”.
    
    [ì¶œë ¥ í˜•ì‹]
    ë°˜ë“œì‹œ ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”. ì˜ë¬¸ í°ë”°ì˜´í‘œë§Œ ì‚¬ìš©í•˜ì„¸ìš”.
    { "newAlternatives": ["ëŒ€ì•ˆ1", "ëŒ€ì•ˆ2", "ëŒ€ì•ˆ3"] }
  `;

  try {
    const { content: rawResponse, model } = await callLLM(prompt);
    const parsedResult = extractJSON(rawResponse);

    if (parsedResult && Array.isArray(parsedResult.newAlternatives)) {
      return parsedResult.newAlternatives;
    }
    return [];
  } catch (e) {
    console.error("Alternative Generation Error:", e);
    return [];
  }
};
